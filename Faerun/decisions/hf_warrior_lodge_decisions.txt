# Warrior Lodges decisions
# By Milla Isaksson

targeted_decisions = {
	duel_decision = {
	    only_playable = yes
	    is_high_prio = yes
	    diplomacy_icon = GFX_duel_decision

	    #ai_target_filter = rivals
		ai_check_interval = 10

	    from_potential = {
	        is_playable = yes
	        is_adult = yes
	        prisoner = no
	        OR = {
	        	AND = {
	        		has_focus = focus_war
			    		has_dlc = "Way of Life"
	        	}
	        	AND = {
	        		has_dlc = "Holy Fury"
					is_member_of_any_warrior_lodge_trigger = yes
	        	}
				is_member_of_any_knight_order_trigger = yes
				AND = {
	        		has_dlc = "Holy Fury"
					any_bloodline = {
						has_bloodline_flag = duelist_bloodline
						bloodline_is_active_for = PREV
					}
	        	}
				trait = patron_torm
	        }
	        has_regent = no
	        is_inaccessible_trigger = no

	        OR = {
	            ai = no

	            is_female = no

	            AND = {
	                is_female = yes
	                OR = {
	                    trait = brave
	                    religion_group = humanoid_group
	                    is_nomadic = yes
	                    gender_equality_trigger = yes
	                }
	            }
	        }
	    }

	    potential = {
	    	OR = {
		    	AND = { #Either you are adult, as well as your target...
		        	is_adult = yes
		    		FROM = { is_adult = yes }
		    	}
		    	AND = { #Or you are both children! WEIRD!
		        	is_adult = no
		    		FROM = { is_adult = no }
		    	}
	    	}
			NOT = { trait = creature_monster }
	        prisoner = no
	        NOT = { character = FROM }
	        is_inaccessible_trigger = no
	    }

	    allow = {
	    	trigger_if = { #[Won't show ANY reqs. if you have "Unrestricted" duels...]
				limit = { #But otherwise: find a target, valid both relationship-, and healthwise...
					NOT = {
						has_game_rule = {
	                        name = dueling
	                        value = unrestricted
	                    }
					}
				}
                OR = { # RELATIONSHIP/mission reqs...
                    custom_tooltip = {
                        text = duel_tooltip_rivals
                        is_rival = FROM
                    }
                    custom_tooltip = {
                        text = duel_tooltip_foes
                        is_foe = FROM
                    }
                    trigger_if = {
                        limit = { religion = FROM }
                    	custom_tooltip = {
                    		text = duel_tooltip_excommunicated
                    		FROM = { trait = zealous }
                        	trait = excommunicated
                    	}
                    }
                    trigger_if = {
                        limit = { FROM = { religion_group = qismaite_group } }
	                    custom_tooltip = {
	                        text = duel_tooltip_decadent
	                        FROM = { trait = zealous }
	                        trait = decadent
	                    }
					}
					trigger_if = {
						limit = { FROM = { trait = patron_torm } }
						custom_tooltip = {
							text = duel_tormtar
							FROM = { trait = patron_torm }
							OR = {
								religion = abyssal_cult
								religion = church_of_cyric
								uthgardt_faith_trigger = yes
								religion = entropy
								religion = blue_flame
								religion = faithless
								trait = patron_bane
								trait = patron_iyachtu_xvim
								trait = patron_bhaal
								trait = patron_mask
								trait = patron_fzoul_chembryl
							}
						}
					}
					trigger_if = {
						limit = {
			                any_quester_targeting_this = { #FROM must have this as a quest target
								character = FROM
								OR = {
									has_quest = quest_warrior_lodge_duel_honor
									has_quest = quest_warrior_lodge_duel_deadly
								}
							}
						}
						custom_tooltip = {
							text = quest_target_tt
							any_quester_targeting_this = { #FROM must have this as a quest target
								character = FROM
								OR = {
									has_quest = quest_warrior_lodge_duel_honor
									has_quest = quest_warrior_lodge_duel_deadly
								}
							}
						}
					}
                }
			}
			
			is_inaccessible_or_incapable_trigger = no
			FROM = {
				is_inaccessible_or_incapable_trigger = no
			}
            #Both are healthy
            custom_tooltip = {
                text = duel_tooltip_sickness
                FROM = {
                	NOR = { #Not in sickly in bed, but sick if well treated is okay
                		has_character_modifier = bedridden_illness
                		has_character_modifier = severe_illness
						trait = incapable
					}
                }
                ROOT = {
                    NOR = { #Not in sickly in bed, but sick if well treated is okay
                		has_character_modifier = bedridden_illness
                		has_character_modifier = severe_illness
						trait = incapable
                    }
                }
            }

            custom_tooltip = {
            	text = duel_tooltip_pregnant
                FROM = { 
					trigger_if = {
						limit = { is_a_mammal_trigger = yes }
						is_pregnant = no
					}
				}
                ROOT = { 
					trigger_if = {
						limit = { is_a_mammal_trigger = yes }
						is_pregnant = no
					}
				}
            }

	                #Checks gender and some religious stuff... (turned this into apply_any_applicable_harsh_penalties_effect instead)
#	                custom_tooltip = {
#	                    text = duel_tooltip_valid_target_updated
#	                    #text = duel_tooltip_valid_target
#	                    hidden_tooltip = { ### Not female or challenger religion accepts female warriors
#	                         OR = {
#	                            is_female = no
#
#	                            is_member_of_roots_warrior_lodge_trigger = yes
	                            #
#	                            #Both FROM and ROOT have gender equality
#	                            AND = {
#	                                OR = {
#	                                    trait = brave
#	                                    gender_equality_trigger = yes
#	                                    religion_group = humanoid_group
#	                                    is_nomadic = yes
#	                                    religion = buddhist
#	                                    religion = bogomilist
#	                                }
#	                                FROM = {
#	                                    OR = {
#	                                        gender_equality_trigger = yes
#	                                        religion_group = humanoid_group
#	                                        is_nomadic = yes
#	                                        religion = buddhist
#	                                        religion = bogomilist
#	                                    }
#	                                }
#	                            }
#	                        }
#	                        ### Not priest or challenger religion is humanoid_group
#	                        trigger_if = {
#	                        	limit = { is_member_of_any_warrior_lodge_trigger = no }
#		                        OR = {
#		                            is_priest = no
#		                            FROM = { religion_group = humanoid_group }
#		                        }
#	                        }
#	                    }
#	                }

	        ####### You won't want to fight someone who is badly injured, and if you are hurt yourself, you will want to wait...
	        custom_tooltip = {
	            text = duel_tooltip_recent_duel
	            hidden_tooltip = {
	                FROM = { NOT = { has_character_modifier = recent_duel_timer } }
	                NOT = { has_character_modifier = recent_duel_timer }
	            }
	        }

	        #############################################################################

	        custom_tooltip = {
	            #text = duel_tooltip_busy
	            text = duel_tooltip_no_war
	            hidden_tooltip = {
	                FROM = {
	                    #NOT = { has_character_flag = do_not_disturb }
	                    NOT = { war = yes }
	                }
	                #NOT = { has_character_flag = do_not_disturb }
	                NOT = { war = yes }
	            }
	        }
	        trigger_if = { #If you do not have this as your mission target, you need to be within diplo-range...
	        	limit = {
	        		NOT = {
						any_quester_targeting_this = { #FROM must have this as a quest target
							character = FROM
							OR = {
								has_quest = quest_warrior_lodge_duel_honor
								has_quest = quest_warrior_lodge_duel_deadly
							}
						}
					}
	        	}
	        	is_within_diplo_range = FROM # CPU HEAVY!
	        }
	        trigger_if = { #If you *do* have this as your mission target, it's fine regardless of range..
	        	limit = {
					any_quester_targeting_this = {
						character = FROM
						OR = {
							has_quest = quest_warrior_lodge_duel_honor
							has_quest = quest_warrior_lodge_duel_deadly
						}
					}
	        	}
	        	OR = {
	        		is_within_diplo_range = FROM
	        		custom_tooltip = {
						text = quest_target_tt
						any_quester_targeting_this = { #FROM must have this as a quest target
							character = FROM
							OR = {
								has_quest = quest_warrior_lodge_duel_honor
								has_quest = quest_warrior_lodge_duel_deadly
							}
						}
					}
	        	}
	        }
	        trigger_if = {
	        	limit = {
					has_character_modifier = has_recently_declined_duel_cooldown
	        	}
	        	custom_tooltip = {
	        		text = opinion_duel_decline_cooldown_tt
		        	NOT = {
		        		has_character_modifier = has_recently_declined_duel_cooldown
					}
	        	}
	        }
	    }

	    effect = {
	    	#REQUIRED event targets for setting up duel evaluation!
	    	FROM = { save_event_target_as = combatant_1 } #the person issuing the duel...
	    	save_event_target_as = combatant_2 #the target of the duel...

	    	apply_degree_of_dishonorable_duel_effect = yes #checks a bunch of age and health statuses...
	    	apply_any_applicable_harsh_penalties_effect = yes #if your target is someone

	        FROM = {
	            pacifists_lose_piety_effect = yes
	            add_character_modifier = {
	                modifier = recent_duel_timer
	                duration = 90
	                hidden = yes
	            }
	        }
	        hidden_tooltip = {
	            character_event = { id = HFP.10095 } #Duel evaluation (hidden) + result event as follow-up.
	        }
	    }
	    ai_will_do = {
	        factor = 1
	        modifier = {
	            factor = 0
	            has_character_modifier = declined_prestige_duel_timer #if the target has already declined a duel, AI's won't attempt to duel them while the timer is still
	        }
	        modifier = {
	            factor = 0.1
	        }
	        modifier = {
	            factor = 1.5
	        	FROM = { potentially_interested_in_rivaling_root_trigger = yes }
	        }
	    }
	}

	########################################
	# 				CLAIM duels 		   #
	########################################
	claim_duel_decision = {
	    only_playable = yes
	    is_high_prio = yes
	    diplomacy_icon = GFX_duel_decision

		ai_check_interval = 10

	    from_potential = {
	        is_playable = yes
	        is_adult = yes
	        prisoner = no
    		has_dlc = "Holy Fury"

    		OR = {
				is_tribal = yes
				religion = dead_three
				orc_religion_trigger = yes
				religion = beholder_pantheon
			}

    		any_claim = {
   				always = yes
    		}

	        has_regent = no
	        is_inaccessible_trigger = no

	        OR = {
	            ai = no
	            is_female = no
	            AND = {
	                is_female = yes
	                OR = {
	                    trait = brave
	                    religion_group = humanoid_group
	                    government = nomadic_tribal_government
	                    gender_equality_trigger = yes
	                }
	            }
	        }
	    }

	    potential = {
			OR = {
				FROM = { is_tribal = yes }
				FROM = { religion = dead_three }
				AND = {
					orc_religion_trigger = yes
					FROM = { orc_religion_trigger = yes }
				}
				AND = {
					religion = beholder_pantheon
					FROM = { religion = beholder_pantheon }
				}
			}
	        OR = {
	        	AND = { # they are independent...
		        	independent = yes
		        	FROM = { has_strong_claim = PREV }
	        	}
	        	AND = { # You share liege...
	        		liege = {
	        			any_vassal = {
	        				character = FROM
	        			}
	        		}
		        	FROM = { has_strong_claim = PREV }
	        	}
#	        	AND = {
#	        		any_vassal = {
#	        			ai = yes
#	        			FROM = { has_strong_claim = PREV }
#	        		}
#	        	}
	        }
	    	OR = {
		    	AND = { #Either you are adult, as well as your target...
		        	is_adult = yes
		    		FROM = { is_adult = yes }
		    	}
		    	AND = { #Or you are both children! WEIRD!
		        	is_adult = no
		    		FROM = { is_adult = no }
		    	}
	    	}

	        prisoner = no
	        NOT = { character = FROM }
	        is_inaccessible_trigger = no
	        FROM = { NOT = { has_character_flag = claim_duel@PREV } }
	    }

	    allow = {
	    	### For CLAIM duels ###
			OR = {
				conditional_tooltip = {
					limit = {
						custom_tooltip = {
							text = both_tribal_tt
							is_tribal = yes
							FROM = { is_tribal = yes }
						}
					}
				}
				conditional_tooltip = {
					limit = {
						FROM = { religion = dead_three }
					}
				}
			}
		    FROM = { has_strong_claim = PREV }

            #Both are healthy
            custom_tooltip = {
                text = duel_tooltip_sickness
                FROM = {
                	NOR = { #Not in sickly in bed, but sick if well treated is okay
                		has_character_modifier = bedridden_illness
                		has_character_modifier = severe_illness
						trait = incapable
					}
                }
                ROOT = {
                    NOR = { #Not in sickly in bed, but sick if well treated is okay
                		has_character_modifier = bedridden_illness
                		has_character_modifier = severe_illness
						trait = incapable
                    }
                }
            }

            #Checks gender and some religious stuff... (turned into apply_any_applicable_harsh_penalties_effect instead)
#            custom_tooltip = {
#                text = duel_tooltip_valid_target
#                hidden_tooltip = { ### Not female or challenger religion accepts female warriors
#                     OR = {
#                        is_female = no
#
#                        is_member_of_roots_warrior_lodge_trigger = yes
                        #
#                        #Both FROM and ROOT have gender equality
#                        AND = {
#                            OR = {
#                                trait = brave
#                                gender_equality_trigger = yes
#                                religion_group = humanoid_group
#                                is_nomadic = yes
#                            }
#                            FROM = {
#                                OR = {
#                                    gender_equality_trigger = yes
#                                    religion_group = humanoid_group
#                                    is_nomadic = yes
#                                }
#                            }
#                        }
#                    }
#                    ### Not priest or challenger religion is humanoid_group
#                    trigger_if = {
#                    	limit = { is_member_of_any_warrior_lodge_trigger = no }
#                        OR = {
#                            is_priest = no
#                            FROM = { religion_group = humanoid_group }
#                        }
#                    }
#                }
#            }

	        custom_tooltip = {
	            text = duel_tooltip_recent_duel
	            hidden_tooltip = {
	                FROM = { NOT = { has_character_modifier = recent_duel_timer } }
	                NOT = { has_character_modifier = recent_duel_timer }
	            }
	        }

	        custom_tooltip = {
	        	text = duel_tooltip_recent_challenge_tt
	            hidden_tooltip = {
	                FROM = { NOT = { has_character_modifier = recently_challenged_rule_timer } }
	            }
	        }

	        custom_tooltip = {
	            #text = duel_tooltip_busy
	            text = duel_tooltip_no_war
	            hidden_tooltip = {
	                FROM = {
	                    #NOT = { has_character_flag = do_not_disturb }
	                    NOT = { war = yes }
	                }
	                #NOT = { has_character_flag = do_not_disturb }
	                NOT = { war = yes }
	            }
	        }

	        is_within_diplo_range = FROM # CPU HEAVY!

	        trigger_if = {
	        	limit = {
					has_character_modifier = has_recently_declined_duel_cooldown
	        	}
	        	custom_tooltip = {
	        		text = opinion_duel_decline_cooldown_tt
		        	NOT = {
		        		has_character_modifier = has_recently_declined_duel_cooldown
					}
	        	}
	        }
	    }

	    effect = {
	    	#REQUIRED event targets for setting up duel evaluation!
	    	FROM = { save_event_target_as = combatant_1 } #the person issuing the duel...
	    	save_event_target_as = combatant_2 #the target of the duel...

	    	apply_degree_of_dishonorable_duel_effect = yes #checks a bunch of age and health statuses...
	    	apply_any_applicable_harsh_penalties_effect = yes

			if = { # If Challenger has more than one claim to fight for...
				limit = {
					any_demesne_title = {
						count > 1
						FROM = { has_strong_claim = PREV }
					}
				}
				random_demesne_title = {
					limit = { event_target:combatant_1 = { has_strong_claim = PREV } }
					preferred_limit = { tier = emperor }
					preferred_limit = { tier = king }
					preferred_limit = { tier = duke }
					preferred_limit = { tier = count }
					preferred_limit = { tier = baron }
					save_event_target_as = target_title
				}
				event_target:combatant_1 = { set_character_flag = wants_multiple_titles_from@event_target:combatant_2 }
			}
			else_if = { # There is only ONE claim involved...
				limit = {
					any_demesne_title = {
						FROM = { has_strong_claim = PREV }
					}
				}
				random_demesne_title = {
					limit = { event_target:combatant_1 = { has_strong_claim = PREV } }
					save_event_target_as = target_title
				}
				event_target:combatant_1 = { set_character_flag = wants_single_title_from@event_target:combatant_2 }
			}

	        FROM = {
	        	set_character_flag = claim_duel@ROOT
	            pacifists_lose_piety_effect = yes
	            add_character_modifier = {
	                modifier = recent_duel_timer
	                duration = 90
	                hidden = yes
	            }
	        }

	        FROM = {
	        	show_scope_change = no
	       		increase_troublemaker_status_effect = yes
	        }

	        hidden_effect = {
		        FROM = {
		        	add_character_modifier = {
		        		modifier = recently_challenged_rule_timer
		                duration = 90
		                hidden = yes
		        	}
		        }
	        }

	        hidden_tooltip = {
	            character_event = { id = HF.10095 days = 1 } #Duel evaluation (hidden) + result event as follow-up.
	        }
	    }
	    ai_will_do = {
	        factor = 1
	        modifier = {
	            factor = 0
	            has_character_modifier = declined_prestige_duel_timer #if the target has already declined a duel, AI's won't attempt to duel them while the timer is still
	        }
	        modifier = {
	            factor = 0.1
	        }
	        modifier = {
	            factor = 1.1
	            trait = brave
	        }
	        modifier = {
	            factor = 1.5
	            trait = ambitious
	        }
	        title_tier_reduction_score = yes
	    }
	}

	########################################


	### Recruit/Induct your child into your warrior lodge ###
	recruit_child_decision = {
	    only_playable = yes
	    is_high_prio = yes
	    diplomacy_icon = GFX_duel_decision
		ai_check_interval = 36

	    from_potential = {
    		has_dlc = "Holy Fury"
	        is_playable = yes
	        is_adult = yes
	        prisoner = no
			is_member_of_any_warrior_lodge_trigger = yes
	        has_regent = no
	        is_inaccessible_trigger = no
	    }

	    potential = {
        	NOT = { character = FROM }
	        prisoner = no
	        is_child_of = FROM

	        OR = {
	            FROM = { ai = no }
	            is_primary_heir = FROM
	        }
	        NOT = { has_character_flag = flag_child_abandoned_lodge }
	    }

	    allow = {
		    age = 12
	    	trigger_if = {
	    		limit = { #can't be in a society already...
	    			is_in_society = yes
	    			NOR = { # but not a secret one...
	    				is_secret_religious_society_member_trigger = yes
		                is_devil_worshiper_trigger = yes
	    			}
	    		}
		    	is_in_society = no
	    	}

	    	trigger_if = {
	    		limit = {
	    			OR = {
	    				has_character_flag = is_being_recruited_to_warrior_lodge_by_parent
	    				has_character_flag = refused_trial
	    			}
	    		}
		    	custom_tooltip = {
		    		text = already_attempted_recruitment_tt
		    		NOR = {
		    			has_character_flag = refused_trial
		    			has_character_flag = is_being_recruited_to_warrior_lodge_by_parent
		    		}
		    	}
	    	}
	    	trigger_if = {
	    		limit = {
	    			OR = { #Either you or the recruit have a bloodline that matters...
		    			FROM = {
		    				any_owned_bloodline = {
								has_bloodline_flag = bloodline_legendary_warrior
							}
		    			}
	    				any_owned_bloodline = {
							has_bloodline_flag = bloodline_legendary_warrior
						}
						custom_tooltip = {
	        				text = has_mission_to_recruit_tt
			        		FROM = {
								has_quest = quest_warrior_lodge_recruit
		        				quest_target = { character = ROOT }
							}
	        			}
    				}
	    		}
	    		OR = {
	    			FROM = { show_scope_change = no has_society_currency_tiny_trigger = yes } #It could cost currency...
	    			custom_tooltip = {
	    				text = legendary_warrior_bloodline_trigger_tt
	    				OR = { #Or you or the recruit have a bloodline that matters...
			    			FROM = {
			    				any_owned_bloodline = {
									has_bloodline_flag = bloodline_legendary_warrior
								}
			    			}
		    				any_owned_bloodline = {
								has_bloodline_flag = bloodline_legendary_warrior
							}
	    				}
	    			}
	    			custom_tooltip = { #Or you have a mission to recruit ROOT...
        				text = has_mission_to_recruit_tt
		        		FROM = {
							has_quest = quest_warrior_lodge_recruit
	        				quest_target = { character = ROOT }
						}
        			}
	    		}
	    	}
	    	trigger_if = {
	    		limit = {
	    			NOR = { #No one has a bloodline that matters...
		    			FROM = {
		    				any_owned_bloodline = {
								has_bloodline_flag = bloodline_legendary_warrior
							}
		    			}
	    				any_owned_bloodline = {
							has_bloodline_flag = bloodline_legendary_warrior
						}
    				}
    				NOT = {
	    				custom_tooltip = {
	        				text = has_mission_to_recruit_tt
			        		FROM = {
								has_quest = quest_warrior_lodge_recruit
		        				quest_target = { character = ROOT }
							}
	        			}
        			}
	    		}
    			FROM = { show_scope_change = no has_society_currency_tiny_trigger = yes } #It could cost currency...
	    	}

	        is_inaccessible_trigger = no

	        custom_tooltip = {
	            text = characters_are_not_busy_tt
	            hidden_tooltip = {
	                FROM = {
	                    NOT = { has_character_flag = do_not_disturb }
	                    NOT = { war = yes }
	                }
	                NOT = { has_character_flag = do_not_disturb }
	                NOT = { war = yes }
	            }
	        }
	        trigger_if = {
	        	limit = { NOT = { is_within_diplo_range = FROM } }
	        	is_within_diplo_range = FROM # CPU HEAVY!
	        }

	        trigger_if = { #If landed, target character must be tribal or nomadic
	        	limit = { is_landed = yes }
	        	OR = {
        			has_tribal_or_nomadic_government_trigger = yes
	        		custom_tooltip = {
        				text = has_mission_to_recruit_tt
		        		FROM = {
							has_quest = quest_warrior_lodge_recruit
	        				quest_target = { character = ROOT }
						}
        			}
	        	}
	        }
	        trigger_if = { #If landed, recruiting character must be tribal or nomadic
	        	limit = { FROM = { is_landed = yes } }
	        	OR = {
        			FROM = { has_tribal_or_nomadic_government_trigger = yes }
        			custom_tooltip = {
        				text = has_mission_to_recruit_tt
		        		FROM = {
							has_quest = quest_warrior_lodge_recruit
	        				quest_target = { character = ROOT }
						}
        			}
	        	}
	        }
	        trigger_if = { #If Uthgardt, must be Temporan
	        	limit = { FROM = { society_member_of = warrior_lodge_uthgardt } }
	        	uthgardt_or_tempuran_trigger = yes
	        	OR = {
        			FROM = { has_tribal_or_nomadic_government_trigger = yes }
        			custom_tooltip = {
        				text = has_mission_to_recruit_tt
		        		FROM = {
							has_quest = quest_warrior_lodge_recruit
	        				quest_target = { character = ROOT }
						}
        			}
	        	}
	        	custom_tooltip = {
        			text = not_arcane_caster_tt
		        	z_arcane_caster = no
        		}
			is_undead = no
	        }
	    }

	    effect = {
	    	FROM = { save_event_target_as = recruiting_parent }

        	if = {
        		limit = {
        			NOR = { #If no one has a bloodline that matters...
		    			FROM = {
		    				any_owned_bloodline = {
								has_bloodline_flag = bloodline_legendary_warrior
							}
		    			}
	    				any_owned_bloodline = {
							has_bloodline_flag = bloodline_legendary_warrior
						}
    				}
    				NOT = {
						custom_tooltip = {
		    				text = has_mission_to_recruit_tt
			        		FROM = {
								has_quest = quest_warrior_lodge_recruit
		        				quest_target = { character = ROOT }
							}
		    			}
		    		}
        		}
        		FROM = { show_scope_change = no detract_society_currency_tiny_effect = yes } #It will cost currency...
        	}


	    	save_event_target_as = new_recruit
	    	set_character_flag = society_join_block
        	set_character_flag = awaiting_initiation_trial
        	set_character_flag = is_being_recruited_to_warrior_lodge_by_parent
	    	#used later for joining correct society:
	    	FROM = { society = { save_event_target_as = warrior_lodge_to_join } }

	        hidden_tooltip = {
	            character_event = { id = HF.10016 }
	        }
	    }
	    ai_will_do = {
	        factor = 1
	    }
	}

##############################
########## POWERS ############
##############################

	#Power, rank 4: Choose Military Aspect
	choose_military_aspect = {
		is_in_society = yes

		filter = self
		ai_target_filter = self
		ai_check_interval = 12

		potential = {
			character = FROM
			has_dlc = "Holy Fury"
			is_playable = yes
			is_adult = yes
			OR = {
				is_member_of_any_warrior_lodge_trigger = yes
				is_member_of_any_knight_order_trigger = yes
				society_member_of = warlock_knights
			}
			society_rank == 4
		}

		allow = {
			has_society_currency_minor_trigger = yes
			custom_tooltip = {
				text = choose_military_aspect_allow_tt
				NOT = { has_character_flag = choosing_military_aspect }
			}
			OR = {
				custom_tooltip = {
					text = does_not_have_a_lifestyle_trait_tt
					NOT = { lifestyle_traits = 1 }
				}
				trait = duelist
				trait = hunter
				trait = strategist
			}
		}

		effect = {
			hidden_tooltip = {
				if = {
					limit = { has_lifestyle_martial_trigger = yes }
					character_event = { id = HF.10020 } #Choose which trait to replace your current with...!
				}
				if = {
					limit = { NOT = { lifestyle_traits = 1 } }
					character_event = { id = HF.10021 } #Choose a path to go down...
				}
			}
			set_character_flag = choosing_military_aspect
			detract_society_currency_minor_effect = yes
		}

		ai_will_do = {
			factor = 1
			modifier = {
				factor = 0
				lifestyle_traits = 1
			}
		}
	}


	#Power, rank 2: Gain Lodge-specific Commander trait
	warrior_training = {
		is_in_society = yes

		filter = self
		ai_target_filter = self
		ai_check_interval = 12

		potential = {
			character = FROM
			has_dlc = "Holy Fury"
			is_playable = yes
			is_adult = yes
			is_member_of_any_warrior_lodge_trigger = yes
			society_rank >= 2
			NOT = { has_character_flag = choosing_warrior_training } #to stop you spamming the button
			has_current_warrior_lodge_leader_trait_trigger = no #to keep it hidden once you're done
		}

		allow = {
			has_society_currency_medium_trigger = yes
			custom_tooltip = {
				text = has_no_warrior_training_with_current_society_tt
				has_current_warrior_lodge_leader_trait_trigger = no
			}
		}

		effect = {
			hidden_tooltip = {
				character_event = { id = HF.10040 } #Gain trait...
			}
			set_character_flag = choosing_warrior_training
			detract_society_currency_medium_effect = yes
		}

		ai_will_do = {
			factor = 1
			modifier = {
				factor = 0.1
				has_religion_matching_joined_warrior_lodge_trigger = no
			}
		}
	}

	#Power, rank 1 (Goblins only): Toughness
	warrior_toughness = {
		is_in_society = yes

		filter = self
		ai_target_filter = self
		ai_check_interval = 12

		potential = {
			character = FROM
			has_dlc = "Holy Fury"
			is_playable = yes
			is_adult = yes
			society_member_of = warrior_lodge_goblins
			society_rank = 1
			NOT = { has_character_flag = using_toughness } #to stop you spamming the button
		}

		allow = {
			has_society_currency_minor_trigger = yes
			has_religion_matching_joined_warrior_lodge_trigger = yes
			custom_tooltip = {
				text = not_already_using_toughness_tt
				NOT = { has_character_flag = using_toughness }
			}
			OR = {
				trait = wounded
				trait = severely_injured
				trait = maimed
				trait = mangled
				trait = infection
			}
		}

		effect = {
			hidden_tooltip = {
				character_event = { id = HF.10055 } #Remove physical injury...
			}
			set_character_flag = using_toughness
			detract_society_currency_minor_effect = yes
		}

		ai_will_do = {
			factor = 1
			modifier = {
				factor = 0.5
				trait = depressed
			}
			modifier = {
				factor = 1.5
				in_command = yes
			}
		}
	}

	#Power, rank 1 (Orcs and Uthgardts): Go Berserk
	warrior_lodge_norse_go_berserk = {
		is_in_society = yes

		filter = self
		ai_target_filter = self
		ai_check_interval = 12

		potential = {
			character = FROM
			has_dlc = "Holy Fury"
			is_playable = yes
			is_adult = yes
			OR = {
				society_member_of = warrior_lodge_uthgardt
				society_member_of = warrior_lodge_orcs
				society_member_of = warrior_lodge_rashemen
			}
			society_rank = 1
			NOT = { has_character_flag = going_berserk } #to stop you spamming the button
		}

		allow = {
			has_society_currency_minor_trigger = yes
			has_religion_matching_joined_warrior_lodge_trigger = yes
			custom_tooltip = {
				text = not_already_going_berserk_tt
				NOT = { has_character_flag = going_berserk }
			}
			OR = {
				NOT = { trait = berserker }
				prisoner = yes
			}
		}

		effect = {
			if = {
				limit = { NOT = { trait = berserker } }
				custom_tooltip = {
					text = gain_berserker_tt #Specifies what the trait gives: must be updated if trait is
					#tooltip = { add_trait = berserker } #no longer needed
				}
			}
			set_character_flag = special_berserker # Will last for at least 10 years
			hidden_effect = {
	    		if = {
	    			limit = {
	    				NOT = { trait = wroth }
	    				NOT = { trait = patient }
	    			}
    				add_trait = wroth
	    		}
				if = {
					limit = { trait = patient }
					remove_trait = patient
				}
				if = {
					limit = { trait = defensive_leader }
					remove_trait = defensive_leader
				}
				if = {
					limit = {
						NOT = { leader_traits = 1 }
						NOT = { trait = aggressive_leader }
					}
					add_trait = aggressive_leader
				}
			}
			hidden_effect = {
				if = {
					limit = { prisoner = no }
					character_event = { id = HF.10056 } #Fires event to handle outcome...
				}
				else = { #Might break you out of prison or have something bonkers happen...
					character_event = { id = HF.10070 } #Fires event to handle outcome...
				}
			}
			set_character_flag = going_berserk
			detract_society_currency_minor_effect = yes
		}

		ai_will_do = {
			factor = 1
			modifier = {
				factor = 0.1
				trait = shy
			}
			modifier = {
				factor = 0.1
				trait = craven
			}
			modifier = {
				factor = 0.1
				trait = patient
			}
			modifier = {
				factor = 0.1
				trait = defensive_leader
			}
		}
	}

	#Power, rank 4: Call to Glory
	warrior_lodge_call_to_glory = {
		only_playable = yes
		is_high_prio = yes
		is_mercenary = yes

		filter = self
		ai_target_filter = self
		ai_check_interval = 12

		potential = {
			character = FROM
			has_dlc = "Holy Fury"
			is_playable = yes
			is_adult = yes
			is_member_of_any_warrior_lodge_trigger = yes
			society_rank = 4
			NOT = { has_character_modifier = call_to_glory }
			OR = {
				ai = no
				any_war = {
					OR = {
						any_defender = {
							character = ROOT
							is_primary_war_defender = yes
						}
						any_attacker = {
							character = ROOT
							is_primary_war_attacker = yes
						}
					}
				}
			}
		}

		allow = {
			war = yes
			has_society_currency_major_trigger = yes
			in_command = yes
		}

		effect = {
			detract_society_currency_major_effect = yes
			custom_tooltip = {
				text = tooltip_lodge_call_to_glory
				hidden_tooltip = {
					set_variable = { which = "call_to_glory_variable" value = 0 } #Cleanup the variable.
					character_event = { id = HF.25030 } #First recurring event.
					add_character_modifier = {
						modifier = call_to_glory
						duration = -1 #Removed by recurring event and on_action when at peace or if leaving society.
					}
				}
			}
		}

		ai_will_do = {
			factor = 0 # decisions with the "is_mercenary" will not be calculated from the script
		}
	}
}

society_decisions = {
	warrior_lodge_legendary_gathering = {
		only_playable = yes
		ai_check_interval = 72
		is_high_prio = yes
		potential = {
			not_casting = yes
			has_dlc = "Holy Fury"
			is_playable = yes
			is_adult = yes
			is_member_of_any_warrior_lodge_trigger = yes
			society_rank == 4
			OR = {
				society_has_active_progress = no
				society = {
					had_flag = {
		                flag = used_legendary_gathering
		                years = 100
		            }
	            }
			}
			NOT = {
				any_bloodline = {
					has_bloodline_flag = legendary_warrior_lodge_bloodline
				}
			}

		}
		allow = {
			has_society_currency_major_trigger = yes
			is_inaccessible_trigger = no
			custom_tooltip = {
				text = legendary_gathering_cd_tt
				society = {
					OR = {
						NOT = { has_flag = used_legendary_gathering }
						had_flag = {
		                    flag = used_legendary_gathering
		                    years = 100
		                }
					}
				}
			}
		}
		effect = {
			detract_society_currency_major_effect = yes
			custom_tooltip = { text = legendary_gathering_tt }
			sound_effect = pagan_warhorn

			if = {
				limit = {
					society = {
						had_flag = {
			                flag = used_legendary_gathering
			                years = 100
			            }
					}
				}
				clr_flag = used_legendary_gathering
			}

			society = { set_flag = used_legendary_gathering } #Needs to be checked (should stick 100 years)

			hidden_effect = {
				society = { clr_flag = block_society_progress }
				if = {
					limit = {
						society_has_active_progress = yes
						society = {
							had_flag = {
				                flag = used_legendary_gathering
				                years = 100
				            }
			            }
					}
					set_society_progress = 0
				}
			}
			start_society_progress = yes
		}
		ai_will_do = {
			factor = 0.2
			modifier = {
				factor = 1.5 #more likely if ambitious
				OR = {
					trait = ambitious
					ai_ambition = 50
				}
			}
			modifier = {
				factor = 0.1
				any_bloodline = { always = yes } #Less likely if already has a bloodline...
			}
			modifier = {
				factor = 0.1
				duelist_skill_is_high_group_trigger = no #less likely if AI is not a great duelist...
			}
			modifier = {
				factor = 0.1 #less likely if irrational
				NOT = { ai_rationality = 0 }
			}
		}
	}

	warrior_lodge_summon_commander = {
		only_playable = yes
		ai_check_interval = 72
		potential = {
			not_casting = yes
			has_dlc = "Holy Fury"
			is_playable = yes
			is_adult = yes
			is_member_of_any_warrior_lodge_trigger = yes
			society_rank = 2
			trigger_if = {
				limit = { ai = yes }
				
				free_court_slots >= 5
			}
		}
		allow = {
			has_society_currency_medium_trigger = yes
			is_inaccessible_trigger = no
		}
		effect = {
			detract_society_currency_medium_effect = yes
			custom_tooltip = { text = tooltip_summoning_lodge_commander }
			hidden_tooltip = {
			if = {
				limit = { has_religion_feature = religion_matriarchal }
				create_random_soldier = {
					random_traits = yes
					dynasty = none
					female = yes
					attributes = {
						diplomacy = 4
						learning = 4
						stewardship = 4
						intrigue = 4
						martial = 14
					}
				}
			}
			if = {
				limit = { NOT = { has_religion_feature = religion_matriarchal } }
				create_random_soldier = {
					random_traits = yes
					dynasty = none
					female = no
					attributes = {
						diplomacy = 4
						learning = 4
						stewardship = 4
						intrigue = 4
						martial = 14
					}
				}
			}
			if = {
				limit = {
					NOR = {
						has_religion_feature = religion_matriarchal
						has_religion_feature = religion_patriarchal
					}
					has_game_rule = {
						name = gender
						value = all
					}
				}
				create_random_soldier = {
					random_traits = yes
					dynasty = none
					female = 50
					attributes = {
						diplomacy = 4
						learning = 4
						stewardship = 4
						intrigue = 4
						martial = 14
					}
				}
			}
			if = {
				limit = {
					NOR = {
						has_religion_feature = religion_matriarchal
						has_religion_feature = religion_patriarchal
						has_game_rule = {
							name = gender
							value = all
						}
					}
				}
				create_random_soldier = {
					random_traits = yes
					dynasty = none
					female = 5
					attributes = {
						diplomacy = 4
						learning = 4
						stewardship = 4
						intrigue = 4
						martial = 14
					}
				}
			}
			if = {
				limit = { has_religion_feature = religion_patriarchal }
				create_random_soldier = {
					random_traits = yes
					dynasty = none
					female = no
					attributes = {
						diplomacy = 4
						learning = 4
						stewardship = 4
						intrigue = 4
						martial = 14
					}
				}
			}
			}
			new_character = {
				remove_all_negative_congenital_traits_effect = yes
				remove_trait = dull

				remove_lifestyle_trait_effect = yes
				if = {
					limit = {
						is_female = yes
						ROOT = {
							NOR = {
								has_religion_feature = religion_matriarchal
								has_religion_feature = religion_patriarchal
								has_game_rule = {
									name = gender
									value = all
								}
							}
						}
					}
					set_character_flag = special_marshal
				}

				random_list = { # Flavor Randomization
					35 = {
						# Nothing
					}
					15 = {
						change_martial = 2
					}
					10 = {
						add_trait = robust
					}
					10 = {
						add_trait = duelist
					}
					10 = {
						add_trait = hunter
					}
					5 = {
						add_trait = strategist
					}
					5 = {
						change_martial = 4
					}
					5 = {
						trigger = {
							has_dlc = "Reapers"
							race_is_one_eyed = no
						}
						add_trait = one_eyed
					}
					5 = {
						add_trait = shrewd
					}
					3 = {
						add_trait = giant
					}
				}
				join_prev_warrior_lodge_society_effect = yes
				hidden_tooltip = {
					random = {
						chance = 50  #Chance of the commander being spawned from another religion.
						give_this_warrior_lodge_religion_effect = yes
						set_character_flag = ai_flag_refuse_conversion	#In which case don't allow liege to immediately demand conversion.
					}
					add_warrior_lodge_leader_trait_effect = yes
					if = {
						limit = {
							has_religion_feature = religion_no_leader
							religion_group = pagan_group
						}
						random_list = {
							5 = {
								add_trait = pagan_branch_1
							}
							25 = {
								add_trait = pagan_branch_2
							}
							25 = {
								add_trait = pagan_branch_3
							}
							25 = {
								add_trait = pagan_branch_4
							}
						}
					}
				}
				set_character_flag = invited_lodge_soldier
				set_character_flag = lodge_warrior_original_court_@ROOT
				set_character_flag = no_court_invites

				random_list = {
					10 = {
						set_variable = { which = local_class_selection_lvl value = 3 } # expert level
					}
					50 = {
						set_variable = { which = local_class_selection_lvl value = 2 } # journeyman level
					}
					40 = {
						set_variable = { which = local_class_selection_lvl value = 1 } # trained level
					}
				}

				pick_martial_class_effect = yes

				save_event_target_as = invited_lodge_soldier
			}
			character_event = { id = HF.25000 }
		}
		ai_will_do = {
			factor = 0.2
			modifier = {
				factor = 0.5
				war = no #Only summon in time of need.
			}
			modifier = {
				factor = 0.1
				any_courtier = { is_member_of_any_warrior_lodge_trigger = yes } #Less likely to invite if there is already someone else at court.
			}
			modifier = {
				factor = 0.1
				any_courtier = { has_job_title = job_marshal martial = 16 }
			}
			modifier = {
				factor = 0.25 #Fearful to be challenged for leadership.
				is_tribal = yes
				trait = paranoid
			}
			modifier = {
				factor = 0 #Only use if empty commander spots.
           		OR = {
                	AND = {
                    	tier = COUNT
                        any_realm_character = {
                            count = 2
                            liege = { character = ROOT }
                            has_minor_title = title_commander
                        }
                	}
                	AND = {
                    	tier = DUKE
                        any_realm_character = {
                            count = 4
                            liege = { character = ROOT }
                            has_minor_title = title_commander
                        }
                	}
                	AND = {
                    	tier = KING
                   		 is_nomadic = no
                        any_realm_character = {
                            count = 6
                            liege = { character = ROOT }
                            has_minor_title = title_commander
                        }
                	}
               		AND = {
                	    tier = EMPEROR
                	    is_nomadic = no
                        any_realm_character = {
                            count = 8
                            liege = { character = ROOT }
                            has_minor_title = title_commander
                        }
                	}
                	AND = {
                	    tier = KING
                 	   is_nomadic = yes
                        any_realm_character = {
                            count = 2
                            liege = { character = ROOT }
                            has_minor_title = title_commander
                        }
                	}
               		AND = {
                	    tier = EMPEROR
                	    is_nomadic = yes
                        any_realm_character = {
                            count = 4
                            liege = { character = ROOT }
                            has_minor_title = title_commander
                        }
                	}
            	}
			}
		}
	}
	# finnish/slavic/tengri removed

	warrior_lodge_war_sacrifice = {
		is_in_society = yes
		ai_check_interval = 6 #check only once every 6 months.
		potential = {
			not_casting = yes
			has_dlc = "Holy Fury"
			is_playable = yes
			is_adult = yes
			NOR = {
				society_member_of = warrior_lodge_elven
				society_member_of = warrior_lodge_dwarven
			}
			is_member_of_any_warrior_lodge_trigger = yes
			society_rank >= 3
			OR = {
				ai = no
				any_war = {
					OR = {
						any_defender = {
							character = ROOT
							is_primary_war_defender = yes
						}
						any_attacker = {
							character = ROOT
							is_primary_war_attacker = yes
						}
					}
				}
			}
		}
		allow = {
			has_society_currency_medium_trigger = yes
			is_inaccessible_trigger = no
			NOT = { trait = incapable }
			custom_tooltip = {
				text = tooltip_war_sacrifice_cooldown
				hidden_tooltip = {
					NOR = {
						has_character_modifier = lodge_war_sacrifice_cooldown
						has_character_flag = flag_picking_war_sacrifice
					}
				}
			}
		}
		effect = {
			detract_society_currency_medium_effect = yes
			custom_tooltip = { text = tooltip_lodge_war_sacrifice }
			set_character_flag = flag_picking_war_sacrifice
			hidden_tooltip = {
				character_event = { id = HF.25021 }
			}
		}
		ai_will_do = {
			factor = 0.1
			modifier = {
				factor = 0.5
				trait = stubborn
			}
			modifier = {
				factor = 1.5
				has_religion_matching_joined_warrior_lodge_trigger = no
			}
			modifier = {
				factor = 0.5
				trait = craven
			}
			modifier = {
				factor = 0
				war = no
			}
			modifier = { #I am losing the war, help!
				factor = 10
				any_war = {
					defender = { character = ROOT }
					attacker = {
						war_score = -50
					}
				}
			}
			modifier = { #I am winning the war, no need!
				factor = 0.25
				any_war = {
					defender = { character = ROOT }
					attacker = {
						war_score = 50
					}
				}
			}
			modifier = {
				factor = 2
				trait = zealous
				religion_group = humanoid_group
			}
			modifier = {
				factor = 0
				trait = zealous
				NOT = { religion_group = humanoid_group }
			}
			modifier = {
				factor = 3
				trait = brave
			}
			modifier = {
				factor = 5
				is_generic_sacrifice_religion = yes
			}
		}
	}
	# Zun/West African removed
}
# create hellenic lodge removed

settlement_decisions = {
	#Power, rank 3: Inspire Warriors
	warrior_lodge_inspire_warriors = {
		ai_check_interval = 80 #check only once every 80 months.
		filter = owned
		ai_target_filter = owned

		from_potential = {
			is_playable = yes
			has_dlc = "Holy Fury"
			higher_tier_than = BARON
			is_member_of_any_warrior_lodge_trigger = yes
			society_rank >= 3
			NOT = { has_character_flag = inspiring_warriors }
		}

		potential = {
			holder_scope = {
				character = FROM
			}
		}
		allow = {
			#show_only_failed_conditions = yes
			FROM = {
				show_scope_change = no
				has_society_currency_minor_trigger = yes
			}
			NOT = { holding_total_levy_percent = 1 } #Holding does not have a full garrison or levy
		}
		effect = {
			save_event_target_as = target_holding
			FROM = {
				show_scope_change = no
				set_character_flag = inspiring_warriors
				detract_society_currency_minor_effect = yes
				character_event = { id = HF.10059 }	#handle actual effect
			}
		}

		ai_will_do = {
			factor = 1
			modifier = { #I am losing the war, help!
				factor = 1.5
				any_war = {
					defender = { character = FROM }
					attacker = {
						war_score = -50
					}
				}
			}
			modifier = { #I am winning the war, no need!
				factor = 0
				any_war = {
					defender = { character = FROM }
					attacker = {
						war_score = 50
					}
				}
			}
			modifier = { #I am not at war, who cares!
	            factor = 0
	            FROM = { war = no }
	        }
		}
	}

	# baltic removed
}
