namespace = fr_prepared_invasion

# Clean up event for religion conversion without nomadic tribal government
character_event = {
	id = fr_prepared_invasion.1 # HF.49202
	desc = fr_prepared_invasion_desc.1
	is_triggered_only = yes
	picture = {
		trigger = { NOT = { government = nomadic_tribal_government } }
		picture = GFX_evt_steppe_mercenaries
	}
	picture = {
		trigger = { culture = aslanlar }
		picture = GFX_evt_moors
	}
	picture = {
		trigger = { culture = eraka }
		picture = GFX_evt_savage_frontier
	}
	picture = {
		trigger = { culture = gnoll }
		picture = GFX_evt_gnoll_1
	}
	picture = {
		trigger = { culture = wemic }
		picture = GFX_evt_wemic
	}
	picture = {
		trigger = { culture = centaur }
		picture = GFX_evt_centaur_1
	}
	picture = {
		trigger = {
			OR = {
				culture = goblin
				culture = batiri
				culture = bakemono
				culture = hobgoblin
				culture = bugbear
			}
		}
		picture = GFX_evt_goblins
	}
	picture = {
		trigger = {
			OR = {
				culture = orc
				culture = orog
				culture = tanarukk
			}
		}
		picture = GFX_evt_orcs
	}
	picture = {
		trigger = {
			OR = {
				culture_group = taan_group
				culture = shaaran
				culture = arkaiun
				culture = nar
			}
		}
		picture = GFX_evt_steppe_mercenaries
	}
	has_character_flag = prep_invader
	trigger = {
		NOR = {
			has_character_flag = prepared_invasion_over
			government = nomadic_tribal_government
			is_viking_invader_religion = yes
			has_religion_feature = religion_feature_orc_evil
			AND = {
				OR = {
					religion = orc_reformed
					religion = goblin_reformed
				}
				NOT = { has_dlc = "Holy Fury" }
			}
			has_character_flag = reverting_religion_change
		}
	}

	immediate = {
		set_character_flag = prepared_invasion_over
		remove_character_modifier = launched_prepared_invasion
		remove_opinion = {
			who = persistent_event_target:prep_invader_target
			modifier = preparing_to_invade
		}
		persistent_event_target:prep_invader_target = {
			remove_opinion = {
				who = ROOT
				modifier = preparing_to_invade_me
			}
			clr_character_flag = prep_inv_target
			character_event = { id = fr_prepared_invasion.16 }
		}
		disband_event_forces = prepared_invasion
	}
	option = {
		name = {
			text = EVTOPTB62310
		}
		prestige = -200
		any_realm_lord = {
			opinion = {
				who = ROOT
				modifier = opinion_failed_invasion
			}
		}
	}
}

# Clean up event if you don't wage a war in 2 years after starting preparations
narrative_event = {
    id = fr_prepared_invasion.2
    desc = EVTDESC62310
    title = fr_prepared_invasion_desc.2a
	picture = {
        trigger = { NOT = { government = nomadic_tribal_government } }
        picture = GFX_evt_large_army
	}
	picture = {
        trigger = { culture = aslanlar }
        picture = GFX_evt_moors
	}
	picture = {
        trigger = { culture = eraka }
        picture = GFX_evt_savage_frontier
	}
	picture = {
        trigger = { culture = gnoll }
        picture = GFX_evt_gnoll_1
	}
	picture = {
        trigger = { culture = wemic }
        picture = GFX_evt_wemic
	}
	picture = {
        trigger = { culture = centaur }
        picture = GFX_evt_centaur_1
	}
	picture = {
        trigger = {
            OR = {
                culture = goblin
                culture = batiri
                culture = bakemono
                culture = hobgoblin
                culture = bugbear
            }
        }
        picture = GFX_evt_goblins
	}
	picture = {
        trigger = {
            OR = {
                culture = orc
                culture = orog
                culture = tanarukk
            }
        }
        picture = GFX_evt_orcs
	}
	picture = {
        trigger = {
            OR = {
                culture_group = taan_group
                culture = shaaran
                culture = arkaiun
                culture = nar
            }
        }
        picture = GFX_evt_steppe_mercenaries
	}
	border = GFX_event_narrative_frame_war
    is_triggered_only = yes
    has_character_flag = prep_invader
	trigger = {
		NOT = { has_character_flag = prepared_invasion_over }
        NOT = {
            any_war = {
                attacker = { character = ROOT }
                using_cb = viking_invasion # Not Already Invading
            }
        }
	}

	immediate = {
		set_character_flag = prepared_invasion_over
		remove_character_modifier = launched_prepared_invasion
		remove_opinion = {
			who = persistent_event_target:prep_invader_target
			modifier = preparing_to_invade
		}
		persistent_event_target:prep_invader_target = {
			remove_opinion = {
				who = ROOT
				modifier = preparing_to_invade_me
			}
    		clr_character_flag = prep_inv_target
    		character_event = { id = fr_prepared_invasion.16 }
		}
		disband_event_forces = prepared_invasion
	}

	option = {
		name = {
			text = EVTOPTB62310
		}
		prestige = -200
		piety = -50
		any_realm_lord = {
			opinion = {
				who = ROOT
				modifier = opinion_failed_invasion
			}
		}
	}
}

# Clean up when a prepared invader dies or becomes landless
character_event = {
	id = fr_prepared_invasion.3 # HF.49208
	picture = GFX_evt_steppe_mercenaries
	hide_window = yes
	is_triggered_only = yes
	has_character_flag = prep_invader

	immediate = {
		disband_event_forces = prepared_invasion
		persistent_event_target:prep_invader_target = {
			clr_character_flag = prep_inv_target
			character_event = { id = fr_prepared_invasion.16 days = 1 }
		}
	}
}

# If another CB is used before Prepared Invasion
# Called from on_action: on_war_started
# The Attacker is FROM
character_event = {

	id = fr_prepared_invasion.4
	desc = fr_prepared_invasion_desc.4
    has_character_flag = prep_inv_target
	picture = {
        trigger = { FROM = { NOT = { government = nomadic_tribal_government } } }
        picture = GFX_evt_large_army
	}
	picture = {
        trigger = { FROM = { culture = aslanlar } }
        picture = GFX_evt_moors
	}
	picture = {
        trigger = { FROM = { culture = eraka } }
        picture = GFX_evt_savage_frontier
	}
	picture = {
        trigger = { FROM = { culture = gnoll } }
        picture = GFX_evt_gnoll_1
	}
	picture = {
        trigger = { FROM = { culture = wemic } }
        picture = GFX_evt_wemic
	}
	picture = {
        trigger = { FROM = { culture = centaur } }
        picture = GFX_evt_centaur_1
	}
	picture = {
        trigger = {
            FROM = {
                OR = {
                    culture = goblin
                    culture = batiri
                    culture = bakemono
                    culture = hobgoblin
                    culture = bugbear
                }
            }
        }
        picture = GFX_evt_goblins
	}
	picture = {
        trigger = {
            FROM = {
                OR = {
                    culture = orc
                    culture = orog
                    culture = tanarukk
                }
            }
        }
        picture = GFX_evt_orcs
	}
	picture = {
        trigger = {
            FROM = {
                OR = {
                    culture_group = taan_group
                    culture = shaaran
                    culture = arkaiun
                    culture = nar
                }
            }
        }
        picture = GFX_evt_steppe_mercenaries
	}
	border = GFX_event_normal_frame_war

	is_triggered_only = yes

	trigger = {
		FROM = { has_character_flag = prep_invader }
		ROOT = { has_opinion_modifier = { who = FROM name = preparing_to_invade_me } }
		NOT = {
			any_war = {
				defender = { character = ROOT }
				using_cb = viking_invasion # Declared invasion
			}
		}
	}

	immediate = {
		FROM = { narrative_event = { id = fr_prepared_invasion.17 }	}
	}

	option = {
		name = {
			text = fr_prepared_invasion_desc_opt.4a
		}
	}
}

## Prepared Invasion Ticker ## Adapted from the Reconquista Ticker
character_event = {
	id = fr_prepared_invasion.5
	hide_window = yes
	picture = GFX_evt_steppe_mercenaries
	is_triggered_only = yes
	trigger = {
		persistent_event_target:prep_invader_target = {
			always = yes
			has_character_flag = prep_inv_target
			NOT = { war_with = ROOT }
			independent = yes
			any_realm_title = {
				OR = {
					AND = {
						real_tier = KING
						is_valid_viking_invasion_target = PREV
					}
					any_de_jure_liege_title = {
						real_tier = KING
						is_valid_viking_invasion_target = PREVPREV
					}
				}
			}
			has_opinion_modifier = { who = ROOT name = preparing_to_invade_me }
		}
		OR = {
			government = nomadic_tribal_government
			is_viking_invader_religion = yes
			has_religion_feature = religion_feature_orc_evil
			AND = {
				OR = {
					religion = orc_reformed
					religion = goblin_reformed
				}
				NOT = { has_dlc = "Holy Fury" }
			}
		}
	}

    fail_trigger_effect = {
    	character_event = { id = fr_prepared_invasion.15 }
    }

    immediate = {
		ROOT = { change_variable = { which = prep_invasion_duration value = 1 } }
		if = {
			limit = {
				check_variable = { which = prep_invasion_duration value == 12 }
			}
			ROOT = {
				character_event = { id = fr_prepared_invasion.12 }
			}
			persistent_event_target:prep_invader_target = {
				character_event = { id = fr_prepared_invasion.12 }
			}
		}
		if = {
			limit = {
				check_variable = { which = prep_invasion_duration value == 18 }
			}
			ROOT = {
				character_event = { id = fr_prepared_invasion.13 }
			}
			persistent_event_target:prep_invader_target = {
				character_event = { id = fr_prepared_invasion.13 }
			}
		}
		if = {
			limit = {
				check_variable = { which = prep_invasion_duration value == 22 }
			}
			ROOT = {
				character_event = { id = fr_prepared_invasion.14 }
			}
			persistent_event_target:prep_invader_target = {
				character_event = { id = fr_prepared_invasion.14 }
			}
		}
		if = {
			limit = {
				ai = yes
				prisoner = no
				is_incapable = no
				check_variable = { which = prep_invasion_duration value == 23 }
                NOT = {
                    any_war = {
                        attacker = { character = ROOT }
                        using_cb = viking_invasion # Not Already Invading
                    }
                }
			}
			persistent_event_target:prep_invader_target = {
				#random_realm_title = {
				#	limit = { real_tier = KING is_valid_viking_invasion_target = PREV }
				#	save_event_target_as = ai_prep_invasion_target
					#break = yes
				#}
				random_landed_title = {
					limit = {
						real_tier = KING
						is_valid_viking_invasion_target = PREV
					}
					save_event_target_as = ai_prep_invasion_target
				}
			}
			ROOT = {
				war = { target = persistent_event_target:prep_invader_target casus_belli = viking_invasion thirdparty_title = event_target:ai_prep_invasion_target tier = KING }
		        if = {
			        limit = { ai = yes }
			        capital_scope = {
				        ROOT = {
					        spawn_fleet = {
						        province = closest_to_capital
						        owner = ROOT
						        match_character = ROOT
						        match_mult = 0.5
						        match_min = 25
						        earmark = prepared_invasion
						        cannot_inherit = yes
					        }
				        }
			        }
		        }
			}
		}
    	random_list = {
    		# Nothing
    		15 = {
    		}
    		# A small force flocks to your banner
    		15 = {
                modifier = {
                    factor = 1.25
                    martial = 15
                }
                modifier = {
                    factor = 1.25
                    martial = 20
                }
                modifier = {
                    factor = 1.25
                    diplomacy = 15
                }
                modifier = {
                    factor = 1.25
                    diplomacy = 20
                }
                modifier = {
                    factor = 1.25
                    prestige = 1000
                }
                modifier = {
                    factor = 0.75
                    NOT = { martial = 10 }
                }
                modifier = {
                    factor = 0.5
                    NOT = { martial = 7 }
                }
                modifier = {
                    factor = 0.75
                    NOT = { diplomacy = 10 }
                }
                modifier = {
                    factor = 0.5
                    NOT = { diplomacy = 7 }
                }
                modifier = {
                    factor = 0.5
                    NOT = { prestige = 100 }
                }
                modifier = {
                    factor = 0.75
                    lower_tier_than = DUKE
                }
                modifier = {
                    factor = 0
                    OR = {
                        culture = gnoll
                        culture = bugbear
                        culture = goblin
                        culture = batiri
                        culture = bakemono
                        culture = hobgoblin
                        culture = orc
                        culture = orog
                        culture = tanarukk
                    }
                    government = nomadic_tribal_government
                    relative_power = {
                        who = persistent_event_target:prep_invader_target
                        power = 8.0
                    }
                }
                modifier = {
                    factor = 0.5
                    OR = {
                        culture = gnoll
                        culture = bugbear
                        culture = goblin
                        culture = batiri
                        culture = bakemono
                        culture = hobgoblin
                        culture = orc
                        culture = orog
                        culture = tanarukk
                    }
                    government = nomadic_tribal_government
                    relative_power = {
                        who = persistent_event_target:prep_invader_target
                        power = 4.0
                    }
                }
                modifier = {
                    factor = 0.25
                    OR = {
                        culture = gnoll
                        culture = bugbear
                        culture = goblin
                        culture = batiri
                        culture = bakemono
                        culture = hobgoblin
                        culture = orc
                        culture = orog
                        culture = tanarukk
                    }
                    government = nomadic_tribal_government
                    relative_power = {
                        who = persistent_event_target:prep_invader_target
                        power = 6.0
                    }
                }
                modifier = {
                    factor = 0
                    OR = {
                        NOT = { government = nomadic_tribal_government }
                        AND = {
                            government = nomadic_tribal_government
                            NOR = {
                                culture = gnoll
                                culture = bugbear
                                culture = goblin
                                culture = batiri
                                culture = bakemono
                                culture = hobgoblin
                                culture = orc
                                culture = orog
                                culture = tanarukk
                            }
                        }
                    }
                    relative_power = {
                        who = persistent_event_target:prep_invader_target
                        power = 4.0
                    }
                }
                modifier = {
                    factor = 0.5
                    OR = {
                        NOT = { government = nomadic_tribal_government }
                        AND = {
                            government = nomadic_tribal_government
                            NOR = {
                                culture = gnoll
                                culture = bugbear
                                culture = goblin
                                culture = batiri
                                culture = bakemono
                                culture = hobgoblin
                                culture = orc
                                culture = orog
                                culture = tanarukk
                            }
                        }
                    }
                    relative_power = {
                        who = persistent_event_target:prep_invader_target
                        power = 2.0
                    }
                }
                modifier = {
                    factor = 0.25
                    OR = {
                        NOT = { government = nomadic_tribal_government }
                        AND = {
                            government = nomadic_tribal_government
                            NOR = {
                                culture = gnoll
                                culture = bugbear
                                culture = goblin
                                culture = batiri
                                culture = bakemono
                                culture = hobgoblin
                                culture = orc
                                culture = orog
                                culture = tanarukk
                            }
                        }
                    }
                    relative_power = {
                        who = persistent_event_target:prep_invader_target
                        power = 3.0
                    }
                }
    			character_event = { id = fr_prepared_invasion.8 }
    		}
    		# A significant force flocks to your banner
    		15 = {
    			trigger = {
    			}
                modifier = {
                    factor = 1.25
                    martial = 15
                }
                modifier = {
                    factor = 1.25
                    martial = 20
                }
                modifier = {
                    factor = 1.25
                    diplomacy = 15
                }
                modifier = {
                    factor = 1.25
                    diplomacy = 20
                }
                modifier = {
                    factor = 1.25
                    prestige = 1000
                }
                modifier = {
                    factor = 0.75
                    NOT = { martial = 10 }
                }
                modifier = {
                    factor = 0.5
                    NOT = { martial = 7 }
                }
                modifier = {
                    factor = 0.75
                    NOT = { diplomacy = 10 }
                }
                modifier = {
                    factor = 0.5
                    NOT = { diplomacy = 7 }
                }
                modifier = {
                    factor = 0.5
                    NOT = { prestige = 100 }
                }
                modifier = {
                    factor = 0.75
                    lower_tier_than = DUKE
                }
                modifier = {
                    factor = 0
                    OR = {
                        culture = gnoll
                        culture = bugbear
                        culture = goblin
                        culture = batiri
                        culture = bakemono
                        culture = hobgoblin
                        culture = orc
                        culture = orog
                        culture = tanarukk
                    }
                    government = nomadic_tribal_government
                    relative_power = {
                        who = persistent_event_target:prep_invader_target
                        power = 8.0
                    }
                }
                modifier = {
                    factor = 0.5
                    OR = {
                        culture = gnoll
                        culture = bugbear
                        culture = goblin
                        culture = batiri
                        culture = bakemono
                        culture = hobgoblin
                        culture = orc
                        culture = orog
                        culture = tanarukk
                    }
                    government = nomadic_tribal_government
                    relative_power = {
                        who = persistent_event_target:prep_invader_target
                        power = 4.0
                    }
                }
                modifier = {
                    factor = 0.25
                    OR = {
                        culture = gnoll
                        culture = bugbear
                        culture = goblin
                        culture = batiri
                        culture = bakemono
                        culture = hobgoblin
                        culture = orc
                        culture = orog
                        culture = tanarukk
                    }
                    government = nomadic_tribal_government
                    relative_power = {
                        who = persistent_event_target:prep_invader_target
                        power = 6.0
                    }
                }
                modifier = {
                    factor = 0
                    OR = {
                        NOT = { government = nomadic_tribal_government }
                        AND = {
                            government = nomadic_tribal_government
                            NOR = {
                                culture = gnoll
                                culture = bugbear
                                culture = goblin
                                culture = batiri
                                culture = bakemono
                                culture = hobgoblin
                                culture = orc
                                culture = orog
                                culture = tanarukk
                            }
                        }
                    }
                    relative_power = {
                        who = persistent_event_target:prep_invader_target
                        power = 4.0
                    }
                }
                modifier = {
                    factor = 0.5
                    OR = {
                        NOT = { government = nomadic_tribal_government }
                        AND = {
                            government = nomadic_tribal_government
                            NOR = {
                                culture = gnoll
                                culture = bugbear
                                culture = goblin
                                culture = batiri
                                culture = bakemono
                                culture = hobgoblin
                                culture = orc
                                culture = orog
                                culture = tanarukk
                            }
                        }
                    }
                    relative_power = {
                        who = persistent_event_target:prep_invader_target
                        power = 2.0
                    }
                }
                modifier = {
                    factor = 0.25
                    OR = {
                        NOT = { government = nomadic_tribal_government }
                        AND = {
                            government = nomadic_tribal_government
                            NOR = {
                                culture = gnoll
                                culture = bugbear
                                culture = goblin
                                culture = batiri
                                culture = bakemono
                                culture = hobgoblin
                                culture = orc
                                culture = orog
                                culture = tanarukk
                            }
                        }
                    }
                    relative_power = {
                        who = persistent_event_target:prep_invader_target
                        power = 3.0
                    }
                }
    			character_event = { id = fr_prepared_invasion.6 }
    		}
    		# A Hero joins your cause with his retinue
    		2 = {
                modifier = {
                    factor = 1.25
                    martial = 15
                }
                modifier = {
                    factor = 1.25
                    martial = 20
                }
                modifier = {
                    factor = 1.25
                    diplomacy = 15
                }
                modifier = {
                    factor = 1.25
                    diplomacy = 20
                }
                modifier = {
                    factor = 1.25
                    prestige = 1000
                }
                modifier = {
                    factor = 0.75
                    NOT = { martial = 10 }
                }
                modifier = {
                    factor = 0.5
                    NOT = { martial = 7 }
                }
                modifier = {
                    factor = 0.75
                    NOT = { diplomacy = 10 }
                }
                modifier = {
                    factor = 0.5
                    NOT = { diplomacy = 7 }
                }
                modifier = {
                    factor = 0.5
                    NOT = { prestige = 100 }
                }
                modifier = {
                    factor = 0.75
                    lower_tier_than = DUKE
                }
                modifier = {
                    factor = 0
                    OR = {
                        culture = gnoll
                        culture = bugbear
                        culture = goblin
                        culture = batiri
                        culture = bakemono
                        culture = hobgoblin
                        culture = orc
                        culture = orog
                        culture = tanarukk
                    }
                    government = nomadic_tribal_government
                    relative_power = {
                        who = persistent_event_target:prep_invader_target
                        power = 8.0
                    }
                }
                modifier = {
                    factor = 0.5
                    OR = {
                        culture = gnoll
                        culture = bugbear
                        culture = goblin
                        culture = batiri
                        culture = bakemono
                        culture = hobgoblin
                        culture = orc
                        culture = orog
                        culture = tanarukk
                    }
                    government = nomadic_tribal_government
                    relative_power = {
                        who = persistent_event_target:prep_invader_target
                        power = 4.0
                    }
                }
                modifier = {
                    factor = 0.25
                    OR = {
                        culture = gnoll
                        culture = bugbear
                        culture = goblin
                        culture = batiri
                        culture = bakemono
                        culture = hobgoblin
                        culture = orc
                        culture = orog
                        culture = tanarukk
                    }
                    government = nomadic_tribal_government
                    relative_power = {
                        who = persistent_event_target:prep_invader_target
                        power = 6.0
                    }
                }
                modifier = {
                    factor = 0
                    OR = {
                        NOT = { government = nomadic_tribal_government }
                        AND = {
                            government = nomadic_tribal_government
                            NOR = {
                                culture = gnoll
                                culture = bugbear
                                culture = goblin
                                culture = batiri
                                culture = bakemono
                                culture = hobgoblin
                                culture = orc
                                culture = orog
                                culture = tanarukk
                            }
                        }
                    }
                    relative_power = {
                        who = persistent_event_target:prep_invader_target
                        power = 4.0
                    }
                }
                modifier = {
                    factor = 0.5
                    OR = {
                        NOT = { government = nomadic_tribal_government }
                        AND = {
                            government = nomadic_tribal_government
                            NOR = {
                                culture = gnoll
                                culture = bugbear
                                culture = goblin
                                culture = batiri
                                culture = bakemono
                                culture = hobgoblin
                                culture = orc
                                culture = orog
                                culture = tanarukk
                            }
                        }
                    }
                    relative_power = {
                        who = persistent_event_target:prep_invader_target
                        power = 2.0
                    }
                }
                modifier = {
                    factor = 0.25
                    OR = {
                        NOT = { government = nomadic_tribal_government }
                        AND = {
                            government = nomadic_tribal_government
                            NOR = {
                                culture = gnoll
                                culture = bugbear
                                culture = goblin
                                culture = batiri
                                culture = bakemono
                                culture = hobgoblin
                                culture = orc
                                culture = orog
                                culture = tanarukk
                            }
                        }
                    }
                    relative_power = {
                        who = persistent_event_target:prep_invader_target
                        power = 3.0
                    }
                }
    			character_event = { id = fr_prepared_invasion.7 }
    		}
    	}
    }

    after = {
    	character_event = { id = fr_prepared_invasion.5 days = 30 }
    }
}

# Troops flock to your banner
character_event = {
	id = fr_prepared_invasion.6 # 62320
	desc = fr_prepared_invasion_desc.6

	picture = {
        trigger = { NOT = { government = nomadic_tribal_government } }
        picture = GFX_evt_large_army
	}
	picture = {
        trigger = { culture = aslanlar }
        picture = GFX_evt_moors
	}
	picture = {
        trigger = { culture = eraka }
        picture = GFX_evt_savage_frontier
	}
	picture = {
        trigger = { culture = gnoll }
        picture = GFX_evt_gnoll_1
	}
	picture = {
        trigger = { culture = wemic }
        picture = GFX_evt_wemic
	}
	picture = {
        trigger = { culture = centaur }
        picture = GFX_evt_centaur_1
	}
	picture = {
        trigger = {
            OR = {
                culture = goblin
                culture = batiri
                culture = bakemono
                culture = hobgoblin
                culture = bugbear
            }
        }
        picture = GFX_evt_goblins
	}
	picture = {
        trigger = {
            OR = {
                culture = orc
                culture = orog
                culture = tanarukk
            }
        }
        picture = GFX_evt_orcs
	}
	picture = {
        trigger = {
            OR = {
                culture_group = taan_group
                culture = shaaran
                culture = arkaiun
                culture = nar
            }
        }
        picture = GFX_evt_steppe_mercenaries
	}
	border = GFX_event_normal_frame_war

	is_triggered_only = yes

	option = {
		name = EVTOPTA62320
		capital_scope = {
			ROOT = {
				spawn_unit = {
					province = PREV
					owner = ROOT
					match_character = ROOT
					match_mult = 0.1
					earmark = prepared_invasion
					attrition = 1.0
				}
				spawn_fleet = {
					province = closest_to_capital
					owner = ROOT
					match_character = ROOT
					match_mult = 0.1
					match_min = 7
					earmark = prepared_invasion
				}
			}
		}
	}
}

# A hero and their retinue appear in your court
character_event = {
	id = fr_prepared_invasion.7 # 62321
	desc = fr_prepared_invasion_desc.7

	hide_from = yes
	picture = {
        trigger = { NOT = { government = nomadic_tribal_government } }
        picture = GFX_evt_large_army
	}
	picture = {
        trigger = { culture = aslanlar }
        picture = GFX_evt_moors
	}
	picture = {
        trigger = { culture = eraka }
        picture = GFX_evt_savage_frontier
	}
	picture = {
        trigger = { culture = gnoll }
        picture = GFX_evt_gnoll_1
	}
	picture = {
        trigger = { culture = wemic }
        picture = GFX_evt_wemic
	}
	picture = {
        trigger = { culture = centaur }
        picture = GFX_evt_centaur_1
	}
	picture = {
        trigger = {
            OR = {
                culture = goblin
                culture = batiri
                culture = bakemono
                culture = hobgoblin
                culture = bugbear
            }
        }
        picture = GFX_evt_goblins
	}
	picture = {
        trigger = {
            OR = {
                culture = orc
                culture = orog
                culture = tanarukk
            }
        }
        picture = GFX_evt_orcs
	}
	picture = {
        trigger = {
            OR = {
                culture_group = taan_group
                culture = shaaran
                culture = arkaiun
                culture = nar
            }
        }
        picture = GFX_evt_steppe_mercenaries
	}
	border = GFX_event_normal_frame_war

	is_triggered_only = yes

	option = {
		name = EVTOPTA62321
		capital_scope = {
			create_character = {
				random_traits = yes
				dynasty = NONE
				religion = ROOT
				culture = ROOT
				female = 50
				age = 30
				attributes = {
					martial = 8
				}
				trait = brave
				trait = brilliant_strategist
			}
			new_character = {
				spawn_unit = {
					province = PREV
					owner = ROOT
					match_character = ROOT
					match_mult = 0.15
#					earmark = prepared_invasion
					attrition = 1.0
				}
			}
		}

		spawn_fleet = {
			province = closest_to_capital
			owner = ROOT
			match_character = ROOT
			match_mult = 0.15
			match_min = 10
			earmark = prepared_invasion
		}
	}
}

# A smaller force arrives for the invasion
character_event = {
	id = fr_prepared_invasion.8 # 62322
	desc = fr_prepared_invasion_desc.6

	picture = {
        trigger = { NOT = { government = nomadic_tribal_government } }
        picture = GFX_evt_large_army
	}
	picture = {
        trigger = { culture = aslanlar }
        picture = GFX_evt_moors
	}
	picture = {
        trigger = { culture = eraka }
        picture = GFX_evt_savage_frontier
	}
	picture = {
        trigger = { culture = gnoll }
        picture = GFX_evt_gnoll_1
	}
	picture = {
        trigger = { culture = wemic }
        picture = GFX_evt_wemic
	}
	picture = {
        trigger = { culture = centaur }
        picture = GFX_evt_centaur_1
	}
	picture = {
        trigger = {
            OR = {
                culture = goblin
                culture = batiri
                culture = bakemono
                culture = hobgoblin
                culture = bugbear
            }
        }
        picture = GFX_evt_goblins
	}
	picture = {
        trigger = {
            OR = {
                culture = orc
                culture = orog
                culture = tanarukk
            }
        }
        picture = GFX_evt_orcs
	}
	picture = {
        trigger = {
            OR = {
                culture_group = taan_group
                culture = shaaran
                culture = arkaiun
                culture = nar
            }
        }
        picture = GFX_evt_steppe_mercenaries
	}
	border = GFX_event_normal_frame_war

	is_triggered_only = yes

	option = {
		name = EVTOPTA62320
		capital_scope = {
			ROOT = {
				spawn_unit = {
					province = PREV
					owner = ROOT
					match_character = ROOT
					match_mult = 0.075
					earmark = prepared_invasion
					attrition = 1.0
				}
				spawn_fleet = {
					province = closest_to_capital
					owner = ROOT
					match_character = ROOT
					match_mult = 0.075
					match_min = 5
					earmark = prepared_invasion
				}
			}
		}
	}
}

## Prepared Invasion Announcement Events ##
long_character_event = {
    id = fr_prepared_invasion.9 # Prepared Invasion notification for everyone else
    title = fr_prepared_invasion_desc.9a
	desc = {
        trigger = { FROM = { NOT = { government = nomadic_tribal_government } } }
        text = fr_prepared_invasion_desc.9
	}
	picture = {
		trigger = { FROM = { NOT = { government = nomadic_tribal_government } } }
		picture = GFX_evt_large_army
	}
	desc = {
        trigger = { FROM = { culture = aslanlar } }
        text = fr_prepared_invasion_desc.9a2
	}
	picture = {
		trigger = { FROM = { culture = aslanlar } }
		 picture = GFX_evt_moors
	}
	desc = {
        trigger = { FROM = { culture = eraka } }
        text = fr_prepared_invasion_desc.9b
	}
	picture = {
		trigger = { FROM = { culture = eraka } }
		picture = GFX_evt_savage_frontier
	}
	desc = {
        trigger = { FROM = { culture = gnoll } }
        text = fr_prepared_invasion_desc.9c
	}
	picture = {
		trigger = { FROM = { culture = gnoll } }
		picture = GFX_evt_gnoll_1
	}
	desc = {
        trigger = { FROM = { culture = wemic } }
        text = fr_prepared_invasion_desc.9d
	}
	picture = {
		trigger = { FROM = { culture = wemic } }
		picture = GFX_evt_wemic
	}
	desc = {
        trigger = { FROM = { culture = centaur } }
        text = fr_prepared_invasion_desc.9e
	}
	picture = {
		trigger = { FROM = { culture = centaur } }
		picture = GFX_evt_centaur_1
	}
	desc = {
        trigger = {
            FROM = {
                OR = {
                    culture = goblin
                    culture = batiri
                    culture = bakemono
                    culture = hobgoblin
                    culture = bugbear
                }
            }
        }
        text = fr_prepared_invasion_desc.9f
	}
	picture = {
		trigger = {
            FROM = {
                OR = {
                    culture = goblin
                    culture = batiri
                    culture = bakemono
                    culture = hobgoblin
                    culture = bugbear
                }
            }
        }
		picture = GFX_evt_goblins
	}
	desc = {
        trigger = {
            FROM = {
                OR = {
                    culture = orc
                    culture = orog
                    culture = tanarukk
                }
            }
        }
        text = fr_prepared_invasion_desc.9g
	}
	picture = {
		trigger = {
            FROM = {
                OR = {
                    culture = orc
                    culture = orog
                    culture = tanarukk
                }
            }
        }
		picture = GFX_evt_orcs
	}
	desc = {
        trigger = {
            FROM = {
                OR = {
                    culture_group = taan_group
                    culture = shaaran
                    culture = arkaiun
                    culture = nar
                }
            }
        }
        text = fr_prepared_invasion_desc.9h
	}
	picture = {
		trigger = {
            FROM = {
                OR = {
                    culture_group = taan_group
                    culture = shaaran
                    culture = arkaiun
                    culture = nar
                }
            }
        }
		picture = GFX_evt_steppe_mercenaries
	}
    border = GFX_event_long_frame_war
    is_triggered_only = yes

    option = {
        name = fr_prepared_invasion_desc_opt.9a
    }
    option = {
        name = fr_prepared_invasion_desc_opt.9b
        custom_tooltip = { text = prep_inv_opt_out_char_tt }
		set_character_flag = prep_inv_no_warning
    }
    option = {
        name = fr_prepared_invasion_desc_opt.9c
        custom_tooltip = { text = prep_inv_opt_out_global_tt }
		set_global_flag = prep_inv_no_warning
    }
}
character_event = {
    id = fr_prepared_invasion.10 # Prepared Invader's first notification
    title = fr_prepared_invasion_desc.9a
    border = GFX_event_normal_frame_war
    picture = GFX_evt_large_army
    is_triggered_only = yes
	desc = {
        trigger = { NOT = { government = nomadic_tribal_government } }
        text = fr_prepared_invasion_desc.10
        picture = GFX_evt_large_army
	}
	desc = {
        trigger = { culture = aslanlar }
        text = fr_prepared_invasion_desc.10a
        picture = GFX_evt_moors
	}
	desc = {
        trigger = { culture = eraka }
        text = fr_prepared_invasion_desc.10b
        picture = GFX_evt_savage_frontier
	}
	desc = {
        trigger = { culture = gnoll }
        text = fr_prepared_invasion_desc.10c
        picture = GFX_evt_gnoll_1
	}
	desc = {
        trigger = { culture = wemic }
        text = fr_prepared_invasion_desc.10d
        picture = GFX_evt_wemic
	}
	desc = {
        trigger = { culture = centaur }
        text = fr_prepared_invasion_desc.10e
        picture = GFX_evt_centaur_1
	}
	desc = {
        trigger = {
            OR = {
                culture = goblin
                culture = batiri
                culture = bakemono
                culture = hobgoblin
                culture = bugbear
            }
        }
        text = fr_prepared_invasion_desc.10f
        picture = GFX_evt_goblins
	}
	desc = {
        trigger = {
            OR = {
                culture = orc
                culture = orog
                culture = tanarukk
            }
        }
        text = fr_prepared_invasion_desc.10g
        picture = GFX_evt_orcs
	}
	desc = {
        trigger = {
            OR = {
                culture_group = taan_group
                culture = shaaran
                culture = arkaiun
                culture = nar
            }
        }
        text = fr_prepared_invasion_desc.10h
        picture = GFX_evt_steppe_mercenaries
	}
	immediate = {
		persistent_event_target:prep_invader_target = { long_character_event = { id = fr_prepared_invasion.11 } }
		any_player = {
			limit = {
				is_within_diplo_range = ROOT
				NOT = { has_global_flag = prep_inv_no_warning }
				NOT = { has_character_flag = prep_inv_no_warning }
				persistent_event_target:prep_invader_target = { NOT = { character = PREV } }
				NOT = { character = ROOT }
			}
			long_character_event = { id = fr_prepared_invasion.9 }
		}
	}


    option = {
        name = fr_prepared_invasion_desc_opt.10a
    }
}
long_character_event = {
    id = fr_prepared_invasion.11 # Prepared Invader Target's first notification
    title = fr_prepared_invasion_desc.9a
	desc = {
        trigger = { FROM = { NOT = { government = nomadic_tribal_government } } }
        text = fr_prepared_invasion_desc.11
	}
	picture = {
		trigger = { FROM = { NOT = { government = nomadic_tribal_government } } }
		picture = GFX_evt_large_army
	}
	desc = {
        trigger = { FROM = { culture = aslanlar } }
        text = fr_prepared_invasion_desc.11a
	}
	picture = {
		trigger = { FROM = { culture = aslanlar } }
		picture = GFX_evt_moors
	}
	desc = {
        trigger = { FROM = { culture = eraka } }
        text = fr_prepared_invasion_desc.11b
	}
	picture = {
		trigger = { FROM = { culture = eraka } }
		picture = GFX_evt_savage_frontier
	}
	desc = {
        trigger = { FROM = { culture = gnoll } }
        text = fr_prepared_invasion_desc.11c
	}
	picture = {
		trigger = { FROM = { culture = gnoll } }
		picture = GFX_evt_gnoll_1
	}
	desc = {
        trigger = { FROM = { culture = wemic } }
        text = fr_prepared_invasion_desc.11d
	}
	picture = {
		trigger = { FROM = { culture = wemic } }
		picture = GFX_evt_wemic
	}
	desc = {
        trigger = { FROM = { culture = centaur } }
        text = fr_prepared_invasion_desc.11e
	}
	picture = {
		trigger = { FROM = { culture = centaur } }
		picture = GFX_evt_centaur_1
	}
	desc = {
        trigger = {
            FROM = {
                OR = {
                    culture = goblin
                    culture = batiri
                    culture = bakemono
                    culture = hobgoblin
                    culture = bugbear
                }
            }
        }
        text = fr_prepared_invasion_desc.11f
	}
	picture = {
		trigger = {
            FROM = {
                OR = {
                    culture = goblin
                    culture = batiri
                    culture = bakemono
                    culture = hobgoblin
                    culture = bugbear
                }
            }
        }
		picture = GFX_evt_goblins
	}
	desc = {
        trigger = {
            FROM = {
                OR = {
                    culture = orc
                    culture = orog
                    culture = tanarukk
                }
            }
        }
        text = fr_prepared_invasion_desc.11g
	}
	picture = {
		trigger = {
            FROM = {
                OR = {
                    culture = orc
                    culture = orog
                    culture = tanarukk
                }
            }
        }
		picture = GFX_evt_orcs
	}
	desc = {
        trigger = {
            FROM = {
                OR = {
                    culture_group = taan_group
                    culture = shaaran
                    culture = arkaiun
                    culture = nar
                }
            }
        }
        text = fr_prepared_invasion_desc.11h
	}
	picture = {
		trigger = {
            FROM = {
                OR = {
                    culture_group = taan_group
                    culture = shaaran
                    culture = arkaiun
                    culture = nar
                }
            }
        }
		picture = GFX_evt_steppe_mercenaries
	}
    border = GFX_event_long_frame_war
    is_triggered_only = yes


    option = {
        name = fr_prepared_invasion_desc_opt.11a
    }
}

character_event = {
	id = fr_prepared_invasion.12 # Notification for 1 year left
	desc = fr_prepared_invasion_desc.12
	picture = GFX_evt_steppe_mercenaries

	is_triggered_only = yes

	option = {
		name = fr_prepared_invasion_desc_opt.12a
	}
}

character_event = {
	id = fr_prepared_invasion.13 # Notification for 6 months left
	desc = fr_prepared_invasion_desc.13
	picture = GFX_evt_steppe_mercenaries

	is_triggered_only = yes

	option = {
		name = fr_prepared_invasion_desc_opt.12a
	}
}

character_event = {
	id = fr_prepared_invasion.14 # Notification for a month left
	desc = fr_prepared_invasion_desc.14
	picture = GFX_evt_steppe_mercenaries

	is_triggered_only = yes

	option = {
		name = fr_prepared_invasion_desc_opt.12a
	}
}

character_event = {
    id = fr_prepared_invasion.15 # Prepared Invasion abort check
	picture = GFX_evt_steppe_mercenaries
	hide_window = yes
    is_triggered_only = yes

	immediate = {
		if = {
            limit = {
                NOT = { has_character_flag = prepared_invasion_over }
                NOT = {
                    any_war = {
                        attacker = { character = ROOT }
                        using_cb = viking_invasion # Not Already Invading
                    }
                }
            }
            narrative_event = { id = fr_prepared_invasion.17 }
        }
	}
}

character_event = {
	id = fr_prepared_invasion.16 # Prepared Invasion Abort Notification for Target
    desc = {
        trigger = {
        	FROM = { war_with = ROOT }
        }
        text = fr_prepared_invasion_desc.16b
    }
    desc = {
        trigger = {
        	ROOT = { independent = no }
        }
        text = fr_prepared_invasion_desc.16c
    }
    desc = {
        trigger = {
        	FROM = {
                NOR = {
                    government = nomadic_tribal_government
                    is_viking_invader_religion = yes
                    has_religion_feature = religion_feature_orc_evil
                    AND = {
                        OR = {
                            religion = orc_reformed
                            religion = goblin_reformed
                        }
                        NOT = { has_dlc = "Holy Fury" }
                    }
                }
            }
        }
        text = fr_prepared_invasion_desc.16d
    }
    desc = {
        trigger = {
        	ROOT = { NOT = { any_realm_title = { real_tier = KING is_valid_viking_invasion_target = PREV } } }
        	ROOT = { realm_size >= 51 }
        }
        text = fr_prepared_invasion_desc.16e
    }
    desc = {
        trigger = {
        	ROOT = { NOT = { any_realm_title = { real_tier = KING is_valid_viking_invasion_target = PREV } } }
        	ROOT = { realm_size < 51 }
        }
        text = fr_prepared_invasion_desc.16f
    }
    desc = {
        trigger = {
        	FROM = { is_alive = no }
        }
        text = fr_prepared_invasion_desc.16g
    }
	picture = {
        trigger = { FROM = { NOT = { government = nomadic_tribal_government } } }
        picture = GFX_evt_large_army
	}
	picture = {
        trigger = { FROM = { culture = aslanlar } }
        picture = GFX_evt_moors
	}
	picture = {
        trigger = { FROM = { culture = eraka } }
        picture = GFX_evt_savage_frontier
	}
	picture = {
        trigger = { FROM = { culture = gnoll } }
        picture = GFX_evt_gnoll_1
	}
	picture = {
        trigger = { FROM = { culture = wemic } }
        picture = GFX_evt_wemic
	}
	picture = {
        trigger = { FROM = { culture = centaur } }
        picture = GFX_evt_centaur_1
	}
	picture = {
        trigger = {
            FROM = {
                OR = {
                    culture = goblin
                    culture = batiri
                    culture = bakemono
                    culture = hobgoblin
                    culture = bugbear
                }
            }
        }
        picture = GFX_evt_goblins
	}
	picture = {
        trigger = {
            FROM = {
                OR = {
                    culture = orc
                    culture = orog
                    culture = tanarukk
                }
            }
        }
        picture = GFX_evt_orcs
	}
	picture = {
        trigger = {
            FROM = {
                OR = {
                    culture_group = taan_group
                    culture = shaaran
                    culture = arkaiun
                    culture = nar
                }
            }
        }
        picture = GFX_evt_steppe_mercenaries
	}

	is_triggered_only = yes

	option = {
		name = fr_prepared_invasion_desc_opt.16a
	}
}

narrative_event = {
    id = fr_prepared_invasion.17 # Prepared Invasion Abort Notification
    title = fr_prepared_invasion_desc.17a
    desc = {
        trigger = {
        	persistent_event_target:prep_invader_target = { war_with = ROOT }
        }
        text = fr_prepared_invasion_desc.17b
    }
    desc = {
        trigger = {
        	persistent_event_target:prep_invader_target = { independent = no }
        }
        text = fr_prepared_invasion_desc.17c
    }
    desc = {
        trigger = {
        	ROOT = {
                NOR = {
                    government = nomadic_tribal_government
                    is_viking_invader_religion = yes
                    has_religion_feature = religion_feature_orc_evil
                    AND = {
                        OR = {
                            religion = orc_reformed
                            religion = goblin_reformed
                        }
                        NOT = { has_dlc = "Holy Fury" }
                    }
                }
            }
        }
        text = fr_prepared_invasion_desc.17d
    }
    desc = {
        trigger = {
        	persistent_event_target:prep_invader_target = { NOT = { any_realm_title = { real_tier = KING is_valid_viking_invasion_target = PREV } } }
        	persistent_event_target:prep_invader_target = { realm_size >= 51 }
        }
        text = fr_prepared_invasion_desc.17e
    }
    desc = {
        trigger = {
        	persistent_event_target:prep_invader_target = { NOT = { any_realm_title = { real_tier = KING is_valid_viking_invasion_target = PREV } } }
        	persistent_event_target:prep_invader_target = { realm_size < 51 }
        }
        text = fr_prepared_invasion_desc.17f
    }
	picture = {
        trigger = { NOT = { government = nomadic_tribal_government } }
        picture = GFX_evt_large_army
	}
	picture = {
        trigger = { culture = aslanlar }
        picture = GFX_evt_moors
	}
	picture = {
        trigger = { culture = eraka }
        picture = GFX_evt_savage_frontier
	}
	picture = {
        trigger = { culture = gnoll }
        picture = GFX_evt_gnoll_1
	}
	picture = {
        trigger = { culture = wemic }
        picture = GFX_evt_wemic
	}
	picture = {
        trigger = { culture = centaur }
        picture = GFX_evt_centaur_1
	}
	picture = {
        trigger = {
            OR = {
                culture = goblin
                culture = batiri
                culture = bakemono
                culture = hobgoblin
                culture = bugbear
            }
        }
        picture = GFX_evt_goblins
	}
	picture = {
        trigger = {
            OR = {
                culture = orc
                culture = orog
                culture = tanarukk
            }
        }
        picture = GFX_evt_orcs
	}
	picture = {
        trigger = {
            OR = {
                culture_group = taan_group
                culture = shaaran
                culture = arkaiun
                culture = nar
            }
        }
        picture = GFX_evt_steppe_mercenaries
	}
    border = GFX_event_narrative_frame_war
    is_triggered_only = yes

	immediate = {
		set_character_flag = prepared_invasion_over
		remove_character_modifier = launched_prepared_invasion
		remove_opinion = {
			who = persistent_event_target:prep_invader_target
			modifier = preparing_to_invade
		}
		persistent_event_target:prep_invader_target = {
			remove_opinion = {
				who = ROOT
				modifier = preparing_to_invade_me
			}
    		clr_character_flag = prep_inv_target
    		character_event = { id = fr_prepared_invasion.16 }
		}
		disband_event_forces = prepared_invasion
	}

	option = {
		name = {
			text = EVTOPTB62310
		}
		prestige = -200
		piety = -50
		any_realm_lord = {
			opinion = {
				who = ROOT
				modifier = opinion_failed_invasion
			}
		}
	}
}

# Transfers prepared invasion eligibility on death
character_event = {
	id = fr_prepared_invasion.18
	hide_window = yes
	picture = GFX_evt_steppe_mercenaries
    is_triggered_only = yes
    has_character_flag = prep_inv_target
    only_independent = yes

    immediate = {
    	current_heir = { save_event_target_as = prepared_invasion_target_heir set_character_flag = prep_inv_target }
    	any_opinion_modifier_target = {
    		limit = { reverse_has_opinion_modifier = { who = PREV modifier = preparing_to_invade_me } }
    		save_persistent_event_target = { name = prep_invader_target scope = event_target:prepared_invasion_target_heir }
    	}
    }
}
