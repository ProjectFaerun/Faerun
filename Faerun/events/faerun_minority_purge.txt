namespace = minorpurg

character_event = {
	id = minorpurg.1
	hide_window = yes

	is_triggered_only = yes

	max_age = 15

	trigger = {
		NOT = { has_character_flag = kid_class }
		OR = {
			trait = naive_appeaser
			trait = underhanded_rogue
			trait = charismatic_negotiator
			trait = grey_eminence
			trait = misguided_warrior
			trait = tough_soldier
			trait = skilled_tactician
			trait = brilliant_strategist
			trait = indulgent_wastrel
			trait = thrifty_clerk
			trait = fortune_builder
			trait = midas_touched
			trait = amateurish_plotter
			trait = flamboyant_schemer
			trait = intricate_webweaver
			trait = elusive_shadow
			trait = detached_priest
			trait = martial_cleric
			trait = scholarly_theologian
			trait = mastermind_theologian
			trait = adventurer
			z_has_class = yes
		}
	}

	immediate = {
		remove_trait = naive_appeaser
		remove_trait = underhanded_rogue
		remove_trait = charismatic_negotiator
		remove_trait = grey_eminence
		remove_trait = misguided_warrior
		remove_trait = tough_soldier
		remove_trait = skilled_tactician
		remove_trait = brilliant_strategist
		remove_trait = indulgent_wastrel
		remove_trait = thrifty_clerk
		remove_trait = fortune_builder
		remove_trait = midas_touched
		remove_trait = amateurish_plotter
		remove_trait = flamboyant_schemer
		remove_trait = intricate_webweaver
		remove_trait = elusive_shadow
		remove_trait = detached_priest
		remove_trait = martial_cleric
		remove_trait = scholarly_theologian
		remove_trait = mastermind_theologian
		remove_all_classes = yes
		remove_trait = adventurer
	}
}

character_event = { #alien culture leaves occupied province
	id = minorpurg.2
	desc = EVTDESC_MINORPURG_2
	picture = GFX_evt_blood_war_1
	is_triggered_only = yes

	only_playable = yes

	trigger = {
		higher_tier_than = BARON
		is_landed = yes

		any_demesne_province = {
			trigger_if = {
				limit = {
					OR = {
						culture = baatezu
						culture = abishai
					}
				}

				ROOT = {
					NOR = {
						culture = baatezu
						culture = abishai
						religion = infernal
						has_character_flag = secret_fiend
					}
				}
			}
			trigger_else_if = {
				limit = { culture = tanarri }

				ROOT = {
					NOR = {
						culture = tanarri
						religion = abyssal_cult
						has_character_flag = secret_fiend
					}
				}
			}
			trigger_else_if = {
				limit = { culture = yugoloth }

				ROOT = {
					NOR = {
						culture = yugoloth
						religion = faithless
						has_character_flag = secret_fiend
					}
				}
			}
			trigger_else_if = {
				limit = { culture = rakshasa }

				ROOT = {
					NOR = {
						culture = rakshasa
						religion = infernal
						religion = abyssal_cult
						religion = interloper
						has_character_flag = secret_fiend
					}
				}
			}
			trigger_else_if = {
				limit = { culture = gehreleth }

				ROOT = {
					NOR = {
						culture = gehreleth
						religion = abyssal_cult
						has_character_flag = secret_fiend
					}
				}
			}
			trigger_else_if = {
				limit = { culture = illithid }

				ROOT = {
					NOR = {
						culture = illithid
						culture = elder_brain
						culture = thoon
						religion = illithid_pantheon
					}
				}
			}
			trigger_else_if = {
				limit = { culture = beholder }

				ROOT = { 
					NOR = { 
						culture = beholder 
						religion = beholder_pantheon
					} 
				}
			}
			trigger_else = {
				always = no
			}

			ROOT = { is_master_for_PREV_trigger = no }
		}
	}

	immediate = {
		random_demesne_province = {
			limit = {
				trigger_if = {
					limit = {
						OR = {
							culture = baatezu
							culture = abishai
						}
					}

					ROOT = {
						NOR = {
							culture = baatezu
							culture = abishai
							religion = infernal
							has_character_flag = secret_fiend
						}
					}
				}
				trigger_else_if = {
					limit = { culture = tanarri }

					ROOT = {
						NOR = {
							culture = tanarri
							religion = abyssal_cult
							has_character_flag = secret_fiend
						}
					}
				}
				trigger_else_if = {
					limit = { culture = yugoloth }

					ROOT = {
						NOR = {
							culture = yugoloth
							religion = faithless
							has_character_flag = secret_fiend
						}
					}
				}
				trigger_else_if = {
					limit = { culture = rakshasa }

					ROOT = {
						NOR = {
							culture = rakshasa
							religion = infernal
							religion = abyssal_cult
							religion = interloper
							has_character_flag = secret_fiend
						}
					}
				}
				trigger_else_if = {
					limit = { culture = gehreleth }

					ROOT = {
						NOR = {
							culture = gehreleth
							religion = abyssal_cult
							has_character_flag = secret_fiend
						}
					}
				}
				trigger_else_if = {
					limit = { culture = illithid }

					ROOT = {
						NOR = {
							culture = illithid
							culture = elder_brain
							culture = thoon
							religion = illithid_pantheon
						}
					}
				}
				trigger_else_if = {
					limit = { culture = beholder }

					ROOT = { 
						NOR = { 
							culture = beholder 
							religion = beholder_pantheon
						} 
					}
				}
				trigger_else = {
					always = no
				}

				ROOT = { is_master_for_PREV_trigger = no }
			}

			save_event_target_as = target_province

			random_neighbor_province = {
				limit = { unconvertable_culture_trigger = no }
				preferred_limit = {
					culture = ROOT
					religion = ROOT
				}
				preferred_limit = {
					OR = {
						culture = ROOT
						religion = ROOT
					}
				}
				preferred_limit = { ROOT = { is_capital = PREV } }
				preferred_limit = { 
					owner = {
						OR = {
							character = ROOT
							same_liege = ROOT
						}
					}
				}

				save_event_target_as = ng_province
			}
		}

		if = {
			limit = { NOT = { event_target:ng_province = { always = yes } } }

			random_realm_province = {
				limit = {
					unconvertable_culture_trigger = no
					NOT = { province = event_target:target_province }
				}
				preferred_limit = {
					culture = ROOT
					religion = ROOT
				}
				preferred_limit = {
					OR = {
						culture = ROOT
						religion = ROOT
					}
				}
				preferred_limit = { ROOT = { is_capital = PREV } }
				preferred_limit = { owner = { character = ROOT } }

				save_event_target_as = ng_province
			}
		}

		if = {
			limit = { NOT = { event_target:ng_province = { always = yes } } }

			random_province = {
				limit = {
					has_owner = yes
					unconvertable_culture_trigger = no
					NOT = { province = event_target:target_province }
				}
				preferred_limit = {
					distance = {
						who = event_target:target_province
						value < 100
					}
				}
				preferred_limit = {
					distance = {
						who = event_target:target_province
						value < 150
					}
				}
				preferred_limit = {
					distance = {
						who = event_target:target_province
						value < 200
					}
				}
				preferred_limit = {
					distance = {
						who = event_target:target_province
						value < 250
					}
				}
				preferred_limit = {
					distance = {
						who = event_target:target_province
						value < 300
					}
				}
				preferred_limit = {
					distance = {
						who = event_target:target_province
						value < 400
					}
				}
				preferred_limit = {
					distance = {
						who = event_target:target_province
						value < 500
					}
				}
				preferred_limit = {
					distance = {
						who = event_target:target_province
						value < 600
					}
				}
				preferred_limit = {
					distance = {
						who = event_target:target_province
						value < 750
					}
				}
				preferred_limit = {
					distance = {
						who = event_target:target_province
						value < 1000
					}
				}
				preferred_limit = {
					distance = {
						who = event_target:target_province
						value < 1500
					}
				}

				save_event_target_as = ng_province
			}
		}
	}

	option = {
		name = EVTOPTA_MINORPURG_2

		if = {
			limit = { NOT = { event_target:ng_province = { always = yes } } }

			# shouldn't be possible, but we foolproof it just in case
			break = yes
		}

		event_target:target_province = {
			hidden_tooltip = {
				if = {
					limit = { culture = baatezu }

					create_random_soldier = {
						random_traits = yes
						attributes = {
							diplomacy = 4
							martial = 6
							stewardship = 2
							intrigue = 4
							learning = 4
						}
						culture = baatezu
						religion = infernal
						dynasty = none
						flag = special_courtier
					}
				}
				else_if = {
					limit = { culture = abishai }

					create_random_soldier = {
						random_traits = yes
						attributes = {
							diplomacy = 4
							martial = 6
							stewardship = 2
							intrigue = 4
							learning = 4
						}
						culture = abishai
						religion = infernal
						dynasty = none
						flag = special_courtier
					}
				}
				else_if = {
					limit = { culture = tanarri }

					create_random_soldier = {
						random_traits = yes
						attributes = {
							diplomacy = 4
							martial = 6
							stewardship = 2
							intrigue = 4
							learning = 4
						}
						culture = tanarri
						religion = abyssal_cult
						dynasty = none
						flag = special_courtier
					}
				}
				else_if = {
					limit = { culture = obyrith }
					
					create_random_soldier = {
						random_traits = yes
						attributes = {
							diplomacy = 4
							martial = 6
							stewardship = 2
							intrigue = 4
							learning = 4
						}
						culture = obyrith
						religion = abyssal_cult
						dynasty = none
						flag = special_courtier
					}
				}
				else_if = {
					limit = { culture = yugoloth }

					create_random_soldier = {
						random_traits = yes
						attributes = {
							diplomacy = 4
							martial = 6
							stewardship = 2
							intrigue = 4
							learning = 4
						}
						culture = yugoloth
						religion = faithless
						dynasty = none
						flag = special_courtier
					}
				}
				else_if = {
					limit = { culture = rakshasa }

					create_random_soldier = {
						random_traits = yes
						attributes = {
							diplomacy = 4
							martial = 6
							stewardship = 2
							intrigue = 4
							learning = 4
						}
						culture = rakshasa
						religion = infernal
						dynasty = none
						flag = special_courtier
					}

					new_character = {
						random = {
							chance = 25

							set_character_flag = ignore_conversion_immunity
							religion = interloper
						}
					}
				}
				else_if = {
					limit = { culture = gehreleth }

					create_random_soldier = {
						random_traits = yes
						attributes = {
							diplomacy = 2
							martial = 5
							stewardship = 2
							intrigue = 5
							learning = 5
						}
						culture = gehreleth
						religion = faithless
						dynasty = none
						flag = special_courtier
					}
					
					new_character = {
						random_list = {
							33 = { }
							33 = {
								set_character_flag = ignore_conversion_immunity
								religion = shadow_gods
							}
							33 = {
								set_character_flag = ignore_conversion_immunity
								religion = abyssal_cult
							}
						}
					}
				}
				else_if = {
					limit = {
						culture = illithid
					}
					create_random_soldier = {
						random_traits = yes
						attributes = {
							diplomacy = 4
							martial = 6
							stewardship = 3
							intrigue = 4
							learning = 4
						}
						culture = illithid
						religion = illithid_pantheon
						trait = genius
						dynasty = none
						flag = special_courtier
					}
				}
				else_if = {
					limit = {
						culture = beholder
					}
					create_random_soldier = {
						random_traits = yes
						attributes = {
							diplomacy = 4
							martial = 6
							stewardship = 2
							intrigue = 4
							learning = 4
						}
						culture = beholder
						religion = beholder_pantheon
						trait = shrewd
						dynasty = none
						flag = special_courtier
					}
				}

				new_character = {
					remove_weak_congenital_trait_effect = yes
					remove_dumb_congenital_trait_effect = yes
					remove_trait = craven
					remove_trait = kind
					remove_trait = charitable
					trigger_switch = {
						on_trigger = trait
						creature_illithid = {
							random_list = {
								2 = {
								}
								1 = {
									remove_trait = creature_illithid
									add_trait = creature_ulitharid
								}
							}
							random_list = {
								1 = {
									add_trait = expert_sorcerer
								}
								1 = {
									add_trait = master_sorcerer
								}
							}
						}
						creature_beholder = {
							random_list = {
								2 = {
								}
								1 = {
									add_trait = elder_orb
									add_trait = giant
									add_trait = strong
								}
							}
							random_list = {
								1 = {
									add_trait = expert_sorcerer
								}
								1 = {
									add_trait = master_sorcerer
								}
							}
						}
						creature_fiend = {
							random_list = {
								2 = {
								}
								1 = {
									add_trait = greater_fiend
								}
							}
							random_list = {
								1 = {
									add_trait = expert_warlock
								}
								1 = {
									add_trait = master_warlock
								}
							}
							add_trait = warlock_fiend
							set_character_flag = got_warlock_pact_weapon
							add_artifact = warlock_pact_weapon
						}
					}

					character_event = { id = minorpurg.3 }
					character_event = { id = frxp.1 }

					log = "[This.GetBestName] leaves the lands of [target_province.GetName]."
				}
			}

			culture = event_target:ng_province
			religion = event_target:ng_province

			hidden_effect = {
				set_variable = { which = prosperity_value value = 0 }
			}
			
			if = {
				limit = {
					has_province_modifier = prosperity_modifier_3
				}
				remove_province_modifier = prosperity_modifier_3
			}
			else_if = {
				limit = {
					has_province_modifier = prosperity_modifier_2
				}
				remove_province_modifier = prosperity_modifier_2
			}
			else_if = {
				limit = {
					has_province_modifier = prosperity_modifier_1
				}
				remove_province_modifier = prosperity_modifier_1
			}
			else_if = {
				limit = {
					has_province_modifier = depopulated_1
				}
				remove_province_modifier = depopulated_1
			}
			else_if = {
				limit = {
					has_province_modifier = depopulated_2
				}
				remove_province_modifier = depopulated_2
			}
			add_province_modifier = {
				name = depopulated_3
				duration = -1
			}
		}
	}
}

#Adventurer title to Host Leader
character_event = {
	id = minorpurg.3
	hide_window = yes

	is_triggered_only = yes

	immediate = {
		liege = {
			primary_title = {
				holder_scope = {
					save_event_target_as = previous_liege
				}
			}
			event_target:target_province = {
				ROOT = {
					set_defacto_liege = ROOT
					create_title = {
						tier = DUKE
						landless = yes
						adventurer = yes
						culture = ROOT
						name = "CLAIMANT_ADVENTURE"
						holder = ROOT
						base_title = THIS
					}
					set_character_flag = raiding_adventurer
					change_variable = { which = global_raiding_adventurer_spawn_by_courtier_MTTH value = 1 }
					character_event = { id = HL.102 } #create troops vikings
					# Create a fleet, just to be sure
					spawn_fleet = {
						province = closest # closest sea zone
						owner = ROOT
						disband_on_peace = yes
						troops =
						{
							galleys = { 110 110 }
						}
					}
				}
			}
		}
		character_event = { id = HL.110 days = 1095 } # Ping to see if he's ready to settle, repeating every 3 years.
	}
}
